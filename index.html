<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Angelique Tarot (CSVç‰ˆ)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&family=Noto+Serif+JP:wght@400;600;900&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #666132;
      --text: #ffffff;
      /* æ–‡å­—ã¯ç™½ç³»ã« */
      --muted: rgba(231, 206, 233, 0.72);
      /* è£œåŠ©æ–‡å­— */
      --line: rgba(133, 45, 45, 0.14);

      --accent: #f0abfc;
      /* å¤©ä½¿ãƒ”ãƒ³ã‚¯ */
      --accent2: #a5b4fc;
      /* ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */

      --good: #86efac;
      --warn: #fde68a;
      --bad: #fda4af;
    }


    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: 'Noto Serif JP', ui-sans-serif, system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(120% 100% at 50% 0%, rgba(245, 230, 179, .08), rgba(0, 0, 0, 0) 60%),
        radial-gradient(80% 70% at 90% 20%, rgba(214, 178, 94, .06), rgba(0, 0, 0, 0) 60%),
        linear-gradient(to bottom, #11111d 0%, #15152b 60%, #0c0c18 100%);
      background-attachment: fixed;
      color: var(--text);
      min-height: 100vh;
    }

    h1,
    h2,
    h3,
    .title,
    .heading {
      font-family: 'Cinzel', 'Noto Serif JP', serif;
      letter-spacing: .04em;
    }




    .app {
      width: min(1100px, 100%)
    }

    header {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title h1 {
      margin: 0;
      font-size: 30px;
      letter-spacing: .04em;
    }

    .title p {
      margin: 0;
      color: var(--muted);
      font-size: 22px;
      line-height: 1.4;
    }

    .panel {
      background: rgba(20, 16, 30, .62);
      /* åŠé€æ˜ã®é—‡ */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);

      border: 1px solid rgba(255, 255, 255, .25);
      border-radius: 18px;
      padding: 14px;

      box-shadow:
        0 14px 40px rgba(0, 0, 0, .45),
        inset 0 0 0 1px rgba(255, 255, 255, .12);
    }


    .topGrid {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
    }

    @media (max-width: 980px) {
      .cardsGrid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 980px) {
      .cardsGrid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 520px) {
      .cardsGrid {
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .cardImg {
        width: 160px;
      }
    }


    .drawMode {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .12);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: transform .12s ease, background .12s ease;
    }

    .chip:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .08)
    }

    .chip input {
      accent-color: var(--accent);
      margin: 0
    }

    .chip strong {
      font-size: 13px
    }

    .chip span {
      font-size: 12px;
      color: var(--muted)
    }

    .btnRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }

    button {
      border: 0;
      cursor: pointer;
      padding: 12px 14px;
      border-radius: 14px;
      color: var(--text);
      background: linear-gradient(135deg, rgba(167, 139, 250, .9), rgba(96, 165, 250, .9));
      font-weight: 700;
      letter-spacing: .02em;
      box-shadow: 0 10px 25px rgba(96, 165, 250, .14);
      transition: transform .12s ease, filter .12s ease;
    }

    button:hover {
      transform: translateY(-1px);
      filter: saturate(1.05)
    }

    button.secondary {
      background: linear-gradient(135deg,
          rgba(240, 171, 252, .95),
          rgba(165, 180, 252, .95));
      box-shadow:
        0 10px 30px rgba(165, 180, 252, .25),
        inset 0 0 0 1px rgba(255, 255, 255, .25);
    }

    button.secondary:hover {
      color: var(--text);
      background: rgba(255, 255, 255, .09)
    }

    .status {
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }

    .stage {
      margin-top: 12px;
      padding: 14px;
    }

    .stageTop {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .stageTitle {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .stageTitle h2 {
      margin: 0;
      font-size: 16px;
    }

    .stageTitle p {
      margin: 0;
      font-size: 12px;
      color: var(--muted);
    }

    .shuffleArea {
      position: relative;
      height: 140px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(0, 0, 0, .25), rgba(0, 0, 0, .15));
      border: 1px solid rgba(255, 255, 255, .10);
      overflow: hidden;
    }

    .deck {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 200px;
      height: 200px;
      transform: translate(-50%, -50%);
      border-radius: 30px;
      overflow: hidden;

      /* â˜…è£é¢ç”»åƒã‚’è¡¨ç¤º */
      background: url("public/cards/back.png") center / cover no-repeat;

      border: 1px solid rgba(255, 255, 255, .18);
      box-shadow: 0 18px 40px rgba(0, 0, 0, .45);
    }

    /* æ–‡å­—ãƒ­ã‚´ã¯æ¶ˆã—ãŸã„ãªã‚‰ã“ã®ã¾ã¾å‰Šé™¤ã—ã¦OK */
    .deck::after {
      content: "";
    }

    /* é£›ã¶ã‚«ãƒ¼ãƒ‰ï¼ˆè£é¢ï¼‰ */
    .fly {
      position: absolute;
      width: 130px;
      height: 185px;
      border-radius: 20px;
      overflow: hidden;

      /* â˜…è£é¢ç”»åƒã‚’è¡¨ç¤º */
      background: url("public/cards/back.png") center / cover no-repeat;

      border: 1px solid rgba(255, 255, 255, .15);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      box-shadow: 0 16px 30px rgba(0, 0, 0, .35);
    }

    .shuffling .deck {
      animation: deckBreath 1.8s ease-in-out infinite;
    }

    @keyframes deckBreath {

      0%,
      100% {
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
        box-shadow: 0 18px 40px rgba(0, 0, 0, .45),
          0 0 22px rgba(200, 160, 255, .35);
      }

      50% {
        transform: translate(-50%, -50%) scale(1.05) rotate(2deg);
        box-shadow: 0 22px 60px rgba(0, 0, 0, .55),
          0 0 38px rgba(160, 200, 255, .55);
      }
    }



    .cardsGrid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .cardsGrid.single {
      grid-template-columns: 1fr;
      justify-items: center;
    }

    .cardsGrid.three {
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      /* ä½™ç™½å°‘ãªã‚ */
      align-items: start;
      justify-items: center;
    }

    /* çœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ï¼ˆå¥½ã¿ã§ï¼‰ */
    .cardsGrid.three .tcard:nth-child(2).cardImg {
      width: 280px;
      /* â† åŸºæœ¬ã‚µã‚¤ã‚º */
      max-width: 90%;
    }


    @media (max-width: 520px) {
      .cardImg {
        width: 170px;
      }

      .cardsGrid.three .tcard:nth-child(2) .cardImg {
        width: 261 0px;
      }
    }

    /* === æ–‡å­—ã®å¯èª­æ€§ã‚’ä¸Šã’ã‚‹é­”æ³• === */
    body,
    .panel,
    .tcard,
    .stage,
    header,
    .status,
    .small,
    .empty {
      text-shadow:
        0 1px 2px rgba(0, 0, 0, .55),
        0 0 6px rgba(0, 0, 0, .35);
    }

    .tcard {
      background: linear-gradient(180deg, rgba(255, 255, 255, .07), rgba(255, 255, 255, .04));
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 18px;
      overflow: hidden;
      box-shadow:
        0 12px 34px rgba(0, 0, 0, .35),
        0 0 0 1px rgba(255, 255, 255, .12),
        0 0 28px rgba(240, 171, 252, .15);
      /* å…‰ */
    }

    .tcardHeader {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 0, 0, .18);
    }

    .tcardTitle {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .tcardTitle .pos {
      font-size: 12px;
      color: rgba(255, 255, 255, .78);
      letter-spacing: .06em;
    }

    .tcardTitle .name {
      font-size: 14px;
      font-weight: 800;
      line-height: 1.2;
    }

    .tcardTitle .sub {
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
    }

    .badge {
      align-self: flex-start;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .15);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .85);
      white-space: nowrap;
    }

    .badge.up {
      border-color: rgba(34, 197, 94, .35);
      background: rgba(34, 197, 94, .12)
    }

    .badge.rev {
      border-color: rgba(245, 158, 11, .35);
      background: rgba(245, 158, 11, .12)
    }

    .tcardVisual {
      padding: 12px;
      display: flex;
      justify-content: center;
    }

    /* çµæœã‚«ãƒ¼ãƒ‰ï¼ˆtcardï¼‰å†…ã®ç”»åƒ */
    /* çµæœã‚«ãƒ¼ãƒ‰ï¼ˆtcardï¼‰å†…ã®ç”»åƒ */
    /* === â‘¡-1 çµæœã‚«ãƒ¼ãƒ‰ç”»åƒã‚’å¤§ãã === */
    /* ===== cardImg ã¯ã“ã“ã§ä¸€æ‹¬ç®¡ç†ï¼ˆæœ€å¾Œã«ç½®ãï¼‰ ===== */
    .cardImg {
      width: 340px;
      /* 3æšã™ã¹ã¦å¤§ãã */
      max-width: 92%;
      height: auto;
      display: block;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, .22);
      box-shadow: 0 22px 46px rgba(0, 0, 0, .45);
    }

    .cardImg.reversed {
      transform: rotate(180deg);
    }

    /* 3æšå¼•ããƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .cardsGrid.three {
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      justify-items: center;
      align-items: start;
    }

    /* çœŸã‚“ä¸­ã ã‘â€œã•ã‚‰ã«â€å¼·èª¿ï¼ˆä»»æ„ã€‚è¦ã‚‰ãªã‘ã‚Œã°æ¶ˆã—ã¦OKï¼‰ */
    .cardsGrid.three .tcard:nth-child(2) .cardImg {
      width: 360px;
    }

    /* 1æšå¼•ã */
    .cardsGrid.single {
      grid-template-columns: 1fr;
      justify-items: center;
    }

    /* ã‚¹ãƒãƒ›èª¿æ•´ */
    @media (max-width: 480px) {
      .cardsGrid.three {
        gap: 10px;
      }

      .cardImg {
        width: 20vw;
      }

      /* 3æšæ¨ªã§åã¾ã‚‹ */
      .cardsGrid.three .tcard:nth-child(2) .cardImg {
        width: 34vw;
      }
    }



    .face {
      width: 128px;
      height: 188px;
      border-radius: 18px;
      background:
        radial-gradient(120px 90px at 30% 20%, rgba(167, 139, 250, .30), transparent 60%),
        radial-gradient(140px 110px at 70% 80%, rgba(96, 165, 250, .22), transparent 65%),
        linear-gradient(180deg, rgba(255, 255, 255, .10), rgba(255, 255, 255, .05));
      border: 1px solid rgba(255, 255, 255, .18);
      box-shadow: 0 16px 30px rgba(0, 0, 0, .40);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      transition: transform .2s ease;
    }

    .face .mono {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 11px;
      color: rgba(255, 255, 255, .7);
      letter-spacing: .1em;
    }

    .face .big {
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .08em;
      color: rgba(255, 255, 255, .86);
      text-align: center;
      padding: 0 12px;
      line-height: 1.25;
    }

    .face.reversed {
      transform: rotate(180deg);
    }

    .tcardBody {
      padding: 0 12px 12px;
      color: rgba(255, 255, 255, .90);
      font-size: 13px;
      line-height: 1.62;
    }

    .line {
      padding: 10px 0;
      border-top: 1px solid rgba(255, 255, 255, .08);
    }

    .line:first-child {
      border-top: 0
    }

    .k {
      color: rgba(255, 255, 255, .90);
      font-weight: 900;
      margin-right: 6px;
    }

    /* Keyword chips */
    .kwWrap {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .kw {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .06);
      color: rgba(255, 255, 255, .88);
      white-space: nowrap;
    }

    .kw.rev {
      border-color: rgba(245, 158, 11, .25);
      background: rgba(245, 158, 11, .10)
    }

    .kw.up {
      border-color: rgba(96, 165, 250, .25);
      background: rgba(96, 165, 250, .10)
    }

    details {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(0, 0, 0, .14);
      overflow: hidden;
    }

    summary {
      cursor: pointer;
      padding: 10px 12px;
      color: rgba(255, 255, 255, .88);
      font-weight: 800;
      list-style: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .detailsBody {
      padding: 0 12px 12px;
      color: rgba(255, 255, 255, .86);
      font-size: 12.5px;
      line-height: 1.6;
    }

    .note {
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(245, 158, 11, .25);
      background: rgba(245, 158, 11, .10);
      color: rgba(255, 255, 255, .88);
      font-size: 12px;
      line-height: 1.55;
    }

    .empty {
      padding: 14px;
      border: 1px dashed rgba(255, 255, 255, .18);
      border-radius: 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      background: rgba(0, 0, 0, .12);
    }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    /* ===== Yes / No è¡¨ç¤ºã‚’å¤§ããã™ã‚‹ ===== */
    .ynRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .yn {
      font-size: 16px;
      /* â† å¤§ãã•ï¼ˆã“ã“ã‚’18ã‚„20ã«ã—ã¦ã‚‚OKï¼‰ */
      font-weight: 900;
      padding: 10px 14px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, .4);
      background: rgba(255, 255, 255, .15);
    }

    .yn.up {
      border-color: #4ade80;
      background: rgba(74, 222, 128, .25);
    }

    .yn.rev {
      border-color: #facc15;
      background: rgba(250, 204, 21, .25);
    }

    .cardWrap {
      display: flex;
      justify-content: center;
      margin-top: 18px;
    }

    /* 1æšå¼•ãã®è¡¨ç¤ºï¼ˆä¸Šã®1æšã ã‘å‡ºã‚‹ã‚«ãƒ¼ãƒ‰ï¼‰ */
    .cardWrap {
      display: flex;
      justify-content: center;
      margin-top: 18px;
    }

    .cardFrame {
      width: min(360px, 78vw);
      /* ä¸­å¤®ã§å¤§ãã‚ */
    }

    #tarotCard.tarotCard {
      width: 100%;
      height: auto;
      display: block;
      aspect-ratio: 2 / 3;
      /* å´©ã‚Œé˜²æ­¢ */
      object-fit: cover;
      border-radius: 18px;
      box-shadow: 0 16px 30px rgba(0, 0, 0, .40);
      border: 1px solid rgba(255, 255, 255, .18);
    }

    /* é€†ä½ç½®ï¼šå›è»¢ã ã‘ã§OKï¼ˆtranslateã¯ä¸è¦ï¼‰ */
    #tarotCard.tarotCard.reversed {
      transform: rotate(180deg);
    }

    /* === å¼·åˆ¶ãƒ†ã‚­ã‚¹ãƒˆå¯è¦–åŒ–ï¼ˆå¿œæ€¥ï¼‰ === */
    /* å¿œæ€¥ã®å¼·åˆ¶ã¯æœ€å°é™ã« */
    body {
      color: var(--text);
    }


    /* ===== è¡¨ç¤ºãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆæœ€çµ‚æ±ºå®šç‰ˆï¼‰ ===== */
    .cardsGrid {
      margin-top: 14px;
      display: grid;
      gap: 16px;
    }

    .cardsGrid.single {
      grid-template-columns: 1fr;
      justify-items: center;
    }

    .cardsGrid.three {
      grid-template-columns: repeat(3, 1fr);
      justify-items: center;
      align-items: start;
    }

    /* ç”»åƒã‚µã‚¤ã‚ºï¼ˆå…¨ä½“ï¼‰ */
    .cardImg {
      width: min(360px, 28vw);
      /* 3æšã¨ã‚‚å¤§ãã„ */
      max-width: 92%;
      height: auto;
      display: block;
      aspect-ratio: 2 / 3;
      object-fit: cover;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, .22);
      box-shadow:
        0 18px 44px rgba(0, 0, 0, .45),
        0 0 36px rgba(240, 171, 252, .12);
    }

    .cardImg.reversed {
      transform: rotate(180deg);
    }

    /* çœŸã‚“ä¸­ã ã‘ã»ã‚“ã®å°‘ã—å¼·èª¿ï¼ˆä¸è¦ãªã‚‰å‰Šé™¤OKï¼‰ */
    .cardsGrid.three .tcard:nth-child(2) .cardImg {
      width: min(400px, 32vw);
    }

    /* ãƒ¢ãƒã‚¤ãƒ« */
    @media (max-width: 480px) {
      .cardsGrid.three {
        gap: 10px;
      }

      .cardImg {
        width: 30vw;
      }

      .cardsGrid.three .tcard:nth-child(2) .cardImg {
        width: 34vw;
      }
    }

    /* === ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼šå…‰ã®ã‚ªãƒ¼ãƒ© === */
    .shuffleArea::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(200, 160, 255, .35),
          rgba(160, 200, 255, .18),
          transparent 60%);
      opacity: .6;
      animation: auraPulse 2.8s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes auraPulse {

      0%,
      100% {
        transform: scale(1);
        opacity: .45
      }

      50% {
        transform: scale(1.08);
        opacity: .75
      }
    }

    /* === é£›ã¶ã‚«ãƒ¼ãƒ‰ã®å‹•ãã‚’å„ªé›…ã«ã™ã‚‹ === */
    .shuffling .fly {
      animation-timing-function: cubic-bezier(.22, .61, .36, 1);
    }

    /* ===== ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆã“ã“ã ã‘è§¦ã‚Œã°OKï¼‰===== */
    :root {
      --deck-size: 240px;
      /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­å¤®ã®æŸï¼ˆå¤§ããï¼‰ */
      --fly-w: 160px;
      /* é£›ã¶ã‚«ãƒ¼ãƒ‰å¹…ï¼ˆå¤§ããï¼‰ */
      --fly-h: 230px;
      /* é£›ã¶ã‚«ãƒ¼ãƒ‰é«˜ã•ï¼ˆå¤§ããï¼‰ */

      --result-w-1: min(300px, 78vw);
      /* 1æšå¼•ãã®çµæœï¼ˆå°‘ã—å°ã•ãï¼‰ */
      --result-w-3: min(240px, 26vw);
      /* 3æšå¼•ãã®çµæœï¼ˆå°ã•ãï¼‰ */
      --result-w-3-mid: min(260px, 28vw);
      /* çœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ */
    }

    /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¨ãƒªã‚¢é«˜ã•ã‚‚å°‘ã—ä¸Šã’ã‚‹ï¼ˆå¤§ããã—ãŸåˆ†ã®ä½™è£•ï¼‰ */
    .shuffleArea {
      height: 220px;
    }

    /* ä¸­å¤®ãƒ‡ãƒƒã‚­ï¼ˆæŸï¼‰ */
    .deck {
      width: var(--deck-size) !important;
      height: var(--deck-size) !important;
      border-radius: 28px;
    }

    /* é£›ã¶ã‚«ãƒ¼ãƒ‰ */
    .fly {
      width: var(--fly-w) !important;
      height: var(--fly-h) !important;
      border-radius: 22px;
    }

    /* çµæœï¼š3æšå¼•ãï¼ˆã„ã¾ cardImg ãŒå¤§ãã™ãã‚‹ã®ã§ä¸‹ã’ã‚‹ï¼‰ */
    .cardsGrid.three .cardImg {
      width: var(--result-w-3) !important;
      max-width: 100%;
    }

    /* çµæœï¼šçœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ï¼ˆä»»æ„ï¼‰ */
    .cardsGrid.three .tcard:nth-child(2) .cardImg {
      width: var(--result-w-3-mid) !important;
    }

    /* çµæœï¼š1æšå¼•ãï¼ˆ#tarotCard ã¯ä»Šä½¿ã£ã¦ãªã„ã‘ã©ä¿é™ºã§ï¼‰ */
    .cardsGrid.single .cardImg {
      width: var(--result-w-1) !important;
      max-width: 100%;
    }

    /* ã‚¹ãƒãƒ›ï¼š3æšæ¨ªä¸¦ã³ã®å´©ã‚Œé˜²æ­¢ */
    @media (max-width: 480px) {
      .shuffleArea {
        height: 200px;
      }

      :root {
        --result-w-3: 28vw;
        --result-w-3-mid: 32vw;
      }
    }

    /* ===== ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼šãƒ‡ãƒƒã‚­ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦è‡ªå‹•ã§åºƒã’ã‚‹ ===== */
    :root {
      /* ã™ã§ã«å…¥ã‚Œã¦ã‚‹ãªã‚‰ã“ã“ã¯åˆã‚ã›ã‚‹ã ã‘ã§OK */
      --deck-size: 240px;
    }

    /* deck ãŒå¤§ãããªã£ã¦ã‚‚åˆ‡ã‚Œãªã„é«˜ã•ã«ã™ã‚‹ */
    .shuffleArea {
      height: calc(var(--deck-size) + 80px) !important;
      /* â† ä½™ç™½ã¶ã‚“å¢—ã‚„ã™ */
      min-height: 220px;
      overflow: hidden;
      /* æ¼”å‡ºã‚’æ å†…ã«åã‚ãŸã„ãªã‚‰ hidden ã®ã¾ã¾ã§OK */
    }

    /* ã‚¹ãƒãƒ›ã¯å°‘ã—æ§ãˆã‚ã« */
    @media (max-width: 520px) {
      .shuffleArea {
        height: calc(var(--deck-size) + 60px) !important;
        min-height: 200px;
      }
    }

    /* ã‚¯ãƒªãƒƒã‚¯ãŒå¸ã‚ã‚Œã‚‹ã®ã‚’é˜²ãï¼ˆè¶…é‡è¦ï¼‰ */
    .shuffleArea,
    .shuffleArea * {
      pointer-events: none;
    }

    /* ãƒœã‚¿ãƒ³ã¯å¿…ãšæŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    #btnDraw {
      pointer-events: auto;
      position: relative;
      z-index: 10;
    }

    :root {
      --deck-w: 220px;
      /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸï¼šå¹… */
      --deck-h: 320px;
      /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸï¼šé«˜ã•ï¼ˆã‚«ãƒ¼ãƒ‰æ¯”ç‡ã«ï¼‰ */
      --deck-radius: 22px;
      /* è§’ä¸¸ */
    }

    /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã®ç®±ã‚’ã€Œã‚«ãƒ¼ãƒ‰é«˜ã• + ä½™ç™½ã€ã« */
    .shuffleArea {
      height: calc(var(--deck-h) + 80px) !important;
      min-height: calc(var(--deck-h) + 80px) !important;
      overflow: hidden;
    }

    .deck {
      width: var(--deck-w) !important;
      height: var(--deck-h) !important;
      border-radius: var(--deck-radius) !important;
      background: url("public/cards/back.png") center / cover no-repeat;
    }

    .fly {
      width: calc(var(--deck-w) * 0.72) !important;
      height: calc(var(--deck-h) * 0.72) !important;
      border-radius: calc(var(--deck-radius) * 0.95) !important;
      background: url("public/cards/back.png") center / cover no-repeat;
    }

    /* ===== ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸã‚’ã€Œã‚«ãƒ¼ãƒ‰æ¯”ç‡(2:3)ã€ã§å›ºå®šã—ã¦ã€ã„ã³ã¤ã‚’è§£æ¶ˆ ===== */
    :root {
      --shuffle-w: 220px;
      /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚«ãƒ¼ãƒ‰ã®å¹…ï¼ˆå¤§ãã•ã¯ã“ã“ï¼‰ */
      --shuffle-r: 22px;
      /* è§’ä¸¸ */
    }

    /* ç®±ã‚‚ã‚«ãƒ¼ãƒ‰é«˜ã•ã«åˆã‚ã›ã¦ç¢ºä¿ï¼ˆåˆ‡ã‚Œé˜²æ­¢ï¼‰ */
    .shuffleArea {
      height: calc(var(--shuffle-w) * 1.5 + 90px) !important;
      /* 1.5 = 3/2 */
      min-height: calc(var(--shuffle-w) * 1.5 + 90px) !important;
      overflow: hidden;
    }

    /* ä¸­å¤®ã®æŸï¼ˆdeckï¼‰ */
    .deck {
      width: var(--shuffle-w) !important;
      height: auto !important;
      aspect-ratio: 2 / 3 !important;
      /* â†ã“ã‚ŒãŒæ±ºå®šæ‰“ */
      border-radius: var(--shuffle-r) !important;
      background: url("public/cards/back.png") center / cover no-repeat !important;
    }

    /* é£›ã¶ã‚«ãƒ¼ãƒ‰ï¼ˆflyï¼‰ã‚‚åŒã˜æ¯”ç‡ã§çµ±ä¸€ */
    .fly {
      width: calc(var(--shuffle-w) * 0.78) !important;
      height: auto !important;
      aspect-ratio: 2 / 3 !important;
      border-radius: calc(var(--shuffle-r) * 0.95) !important;
      background: url("public/cards/back.png") center / cover no-repeat !important;
    }

    .deck,
    .fly {
      background-size: contain !important;
      /* â†åˆ‡ã‚Œãªã„ */
      background-color: rgba(0, 0, 0, .18);
      /* ä½™ç™½ãŒå‡ºãŸæ™‚ã‚‚ç¶ºéº— */
    }

    /* ================================
   ğŸ“± Mobileæœ€é©åŒ–ï¼šã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼†3æšå¼•ã
   ================================ */

    /* ã¾ãšã¯PC/å…±é€šã®åŸºæº–ï¼ˆè§¦ã‚‹ã®ã¯ã“ã“ã ã‘ã§ã‚‚OKï¼‰ */
    :root {
      --shuffle-w: 220px;
      /* PCã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«å¹… */
    }

    /* 3æšå¼•ãï¼šé‡ãªã‚Šã®åŸå› ã¯ã€Œã‚«ãƒ¼ãƒ‰ãŒå¤§ãã™ãã€orã€ŒtcardãŒä¼¸ã³ã¦ã‚‹ã€ãªã®ã§ã€
   ã‚°ãƒªãƒƒãƒ‰ã®å„åˆ—ã‚’â€œå¿…ãšå‡ç­‰â€ã«ã—ã¦ã€ç”»åƒå¹…ã‚’vwã§å›ºå®š */
    .cardsGrid.three {
      grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
      gap: 12px !important;
    }

    .cardsGrid.three .tcard {
      width: 100%;
      min-width: 0;
      /* â† ã“ã‚ŒãŒãªã„ã¨ä¸­èº«ã§æ¨ªã«åºƒãŒã£ã¦é‡ãªã‚‹ã“ã¨ãŒã‚ã‚‹ */
    }

    .cardsGrid.three .cardImg {
      width: 100% !important;
      max-width: 100% !important;
      height: auto;
    }

    /* ---- ãƒ¢ãƒã‚¤ãƒ«æœ¬ç•ªèª¿æ•´ ---- */
    @media (max-width: 520px) {

      /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚«ãƒ¼ãƒ‰ãŒå¤§ãã™ãã‚‹å•é¡Œ */
      :root {
        --shuffle-w: 150px;
        /* â†æºå¸¯ã¯å°ã•ã‚ã« */
      }

      /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç®±ã‚‚é€£å‹•ã—ã¦ç¸®ã‚ã‚‹ */
      .shuffleArea {
        height: calc(var(--shuffle-w) * 1.5 + 60px) !important;
        min-height: calc(var(--shuffle-w) * 1.5 + 60px) !important;
      }

      /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŸï¼†é£›ã¶ã‚«ãƒ¼ãƒ‰ï¼šæ¯”ç‡ã¯ç¶­æŒã—ãŸã¾ã¾ç¸®å° */
      .deck {
        width: var(--shuffle-w) !important;
        aspect-ratio: 2 / 3 !important;
      }

      .fly {
        width: calc(var(--shuffle-w) * 0.78) !important;
        aspect-ratio: 2 / 3 !important;
      }

      /* 3æšå¼•ãï¼šçµ¶å¯¾ã«é‡ãªã‚‰ãªã„ã‚µã‚¤ã‚ºè¨­è¨ˆï¼ˆ3æš=å„1/3å¹…ï¼‰ */
      .cardsGrid.three {
        gap: 8px !important;
      }

      /* ç”»åƒã‚’vwåŸºæº–ã§å›ºå®šï¼ˆç”»é¢å¹…ã«å¯¾ã—ã¦å¸¸ã«åã¾ã‚‹ï¼‰ */
      .cardsGrid.three .cardImg {
        width: 28vw !important;
        /* â† ã“ã“ã‚’ 26ã€œ30 ã§èª¿æ•´ */
        max-width: 28vw !important;
      }

      /* çœŸã‚“ä¸­ã ã‘å°‘ã—å¼·èª¿ã—ãŸã„å ´åˆï¼ˆä»»æ„ã€‚ä¸è¦ãªã‚‰å‰Šé™¤OKï¼‰ */
      .cardsGrid.three .tcard:nth-child(2) .cardImg {
        width: 30vw !important;
        max-width: 30vw !important;
      }

      /* ã‚«ãƒ¼ãƒ‰æ ï¼ˆtcardï¼‰è‡ªä½“ãŒæ¨ªã«åºƒãŒã‚‰ãªã„ã‚ˆã†ã«ä¿é™º */
      .cardsGrid.three .tcard {
        width: 100% !important;
        min-width: 0 !important;
      }
    }

    /* =====================================
   ğŸ“± Mobileã§ã‚‚3æšæ¨ªä¸¦ã³ã‚’å®ˆã‚‹ï¼ˆé‡ãªã‚Šè§£æ¶ˆï¼‰
   ===================================== */
    @media (max-width: 520px) {

      /* 3åˆ—ã‚’ç¶­æŒã—ã¤ã¤â€œã¯ã¿å‡ºã—ç¦æ­¢â€ã®åœŸå° */
      .cardsGrid.three {
        grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
        gap: 8px !important;
        align-items: start;
      }

      /* ã“ã‚ŒãŒè¶…é‡è¦ï¼šä¸­èº«ãŒåŸå› ã§åˆ—å¹…ã‚ˆã‚ŠåºƒãŒã‚‹ã®ã‚’æ­¢ã‚ã‚‹ */
      .tcard,
      .tcardHeader,
      .tcardTitle,
      .tcardBody {
        min-width: 0 !important;
      }

      .tcard {
        width: 100% !important;
        overflow: hidden !important;
        /* éš£ã«ä¹—ã‚Šä¸Šã’ã‚‹ã®ã‚’ç‰©ç†çš„ã«é˜²ã */
      }

      /* ç”»åƒã¯åˆ—å¹…ã«100%ãƒ•ã‚£ãƒƒãƒˆï¼ˆ=é‡ãªã‚Šã®èµ·ç‚¹ã‚’æ¶ˆã™ï¼‰ */
      .cardsGrid.three .cardImg {
        width: 100% !important;
        max-width: 100% !important;
        height: auto !important;
      }

      /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¯â€œç¸¦ç©ã¿â€ã«ã—ã¦æ¨ªã®çªãæŠœã‘ã‚’é˜²ãï¼ˆæ¨ªä¸¦ã³è¡¨ç¤ºã¯ç¶­æŒï¼‰ */
      .tcardHeader {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 6px !important;
        padding: 10px 10px 8px !important;
      }

      /* ãƒãƒƒã‚¸ã‚‚æŠ˜ã‚Šè¿”ã—å¯ã« */
      .badge {
        font-size: 11px !important;
        padding: 5px 8px !important;
        max-width: 100% !important;
        white-space: normal !important;
      }

      /* YES/NO ãƒ”ãƒ«ãŒä¸»çŠ¯ï¼šå°ã•ãï¼†æŠ˜ã‚Šè¿”ã—ï¼†åˆ—ã‹ã‚‰å‡ºãªã„ */
      .ynRow {
        margin-top: 8px !important;
        gap: 6px !important;
        flex-wrap: wrap !important;
      }

      .yn {
        font-size: 12px !important;
        padding: 6px 8px !important;
        line-height: 1.2 !important;
        max-width: 100% !important;
        white-space: normal !important;
        /* â†æŠ˜ã‚Šè¿”ã™ */
        overflow-wrap: anywhere !important;
        /* â†ä¿ç•™/æ—¥æœ¬èªã§ã‚‚çªãæŠœã‘ãªã„ */
      }

      /* æ–‡å­—é‡ã‚‚å°‘ã—ç· ã‚ã¦â€œ3æšæ¨ªâ€ã®å“ã‚’ä¿ã¤ */
      .tcardBody {
        padding: 0 10px 10px !important;
        font-size: 12px !important;
        line-height: 1.55 !important;
      }

      .tcardTitle .name {
        font-size: 13px !important;
      }

      .tcardTitle .sub {
        font-size: 11px !important;
      }

      /* ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãŒæ¨ªã«é•·ã„ã¨æŠ¼ã—å‡ºã™ã®ã§å°‘ã—å°ã•ã */
      .kw {
        font-size: 11px !important;
        padding: 5px 8px !important;
        max-width: 100% !important;
      }
    }

    .coreText {
      margin-top: 6px;
      font-size: 14px;
      line-height: 1.7;
      font-weight: 600;
      color: rgba(255, 255, 255, .95);
    }

    /* =========================
   âœ¨ ã‚«ãƒ¼ãƒ‰ã‚’å¼•ããƒœã‚¿ãƒ³ å¼·åŒ–
   ========================= */
    #btnDraw {
      font-size: 17px;
      /* æ–‡å­—ã‚’å°‘ã—å¤§ãã */
      padding: 16px 26px;
      /* æŠ¼ã—ã‚„ã™ã */
      border-radius: 999px;
      /* å¤©ä½¿çš„ãªä¸¸ã¿ */
      letter-spacing: .08em;
      font-weight: 800;

      background: linear-gradient(135deg,
          rgba(240, 171, 252, .95),
          rgba(165, 180, 252, .95));

      box-shadow:
        0 14px 30px rgba(165, 180, 252, .35),
        0 0 0 1px rgba(255, 255, 255, .35),
        inset 0 0 18px rgba(255, 255, 255, .25);

      position: relative;
      overflow: hidden;
    }

    /* å…‰ãŒãµã‚ã£ã¨æµã‚Œã‚‹ */
    #btnDraw::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 30% 30%,
          rgba(255, 255, 255, .45),
          transparent 60%);
      opacity: .6;
      animation: drawGlow 3s ease-in-out infinite;
      pointer-events: none;
    }

    /* ãƒ›ãƒãƒ¼ï¼šå°‘ã—æŒã¡ä¸ŠãŒã‚‹ */
    #btnDraw:hover {
      transform: translateY(-2px);
      filter: brightness(1.05);
    }

    /* æŠ¼ã—ãŸç¬é–“ï¼šæ²ˆã‚€ */
    #btnDraw:active {
      transform: translateY(0);
      box-shadow:
        0 8px 18px rgba(165, 180, 252, .35),
        inset 0 0 12px rgba(255, 255, 255, .25);
    }

    /* å…‰ã®å‘¼å¸ */
    @keyframes drawGlow {

      0%,
      100% {
        opacity: .35;
      }

      50% {
        opacity: .7;
      }
    }

    /* ===== å¼·åˆ¶é©ç”¨ï¼šã‚«ãƒ¼ãƒ‰ã‚’å¼•ããƒœã‚¿ãƒ³ ===== */
    #btnDraw {
      font-size: 18px !important;
      padding: 18px 28px !important;
      border-radius: 999px !important;
      letter-spacing: .08em !important;
      font-weight: 900 !important;

      background: linear-gradient(135deg,
          rgba(240, 171, 252, .95),
          rgba(165, 180, 252, .95)) !important;

      box-shadow:
        0 14px 30px rgba(165, 180, 252, .35),
        0 0 0 1px rgba(255, 255, 255, .35),
        inset 0 0 18px rgba(255, 255, 255, .25) !important;

      position: relative !important;
      overflow: hidden !important;
      transform: translateY(0) !important;
      cursor: pointer !important;
    }

    /* å…‰ãŒæµã‚Œã‚‹ */
    #btnDraw::before {
      content: "" !important;
      position: absolute !important;
      inset: -40% !important;
      background: radial-gradient(circle at 30% 30%,
          rgba(255, 255, 255, .55),
          transparent 60%) !important;
      opacity: .6 !important;
      animation: drawGlow 3s ease-in-out infinite !important;
      pointer-events: none !important;
    }

    #btnDraw:hover {
      transform: translateY(-2px) !important;
      filter: brightness(1.05) !important;
    }

    #btnDraw:active {
      transform: translateY(0) !important;
    }

    button {
      border: 1px solid rgba(214, 178, 94, .4);
    }

    button:hover {
      box-shadow: 0 0 18px rgba(214, 178, 94, .25);
    }

    @keyframes drawGlow {

      0%,
      100% {
        opacity: .35;
      }

      50% {
        opacity: .75;
      }
    }

    /* ================================
   âœ¨ Angel Button: gold + glow + wing-ish
   ================================ */
    #btnDraw {
      position: relative;
      z-index: 20;
      display: inline-flex;
      align-items: center;
      justify-content: center;

      min-width: 280px !important;
      padding: 18px 34px !important;
      font-size: 18px !important;
      font-weight: 900;
      letter-spacing: .06em;

      color: rgba(40, 28, 10, .92);
      border: 1px solid rgba(255, 255, 255, .35) !important;

      /* ãƒ™ãƒ¼ã‚¸ãƒ¥ç³»ã‚´ãƒ¼ãƒ«ãƒ‰ï¼ˆä¸Šå“ï¼‰ */
      background: linear-gradient(135deg,
          #f6e7c6 0%,
          #efd39a 28%,
          #d7b36a 55%,
          #f3e0b8 100%) !important;

      border-radius: 999px !important;
      /* å¤©ä½¿ã£ã½ã„æŸ”ã‚‰ã‹ã• */
      box-shadow:
        0 14px 30px rgba(0, 0, 0, .28),
        0 0 0 1px rgba(255, 255, 255, .18) inset,
        0 10px 26px rgba(220, 180, 90, .22);

      transition: transform .14s ease, filter .14s ease, box-shadow .14s ease;
      overflow: visible;
    }

    /* ãµã‚ã£ã¨å…‰ã‚‹ã‚ªãƒ¼ãƒ©ï¼ˆå¸¸æ™‚ï¼‰ */
    #btnDraw::before {
      content: "";
      position: absolute;
      inset: -18px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 35%, rgba(255, 245, 214, .65), transparent 55%),
        radial-gradient(circle at 70% 65%, rgba(255, 214, 140, .38), transparent 60%);
      filter: blur(10px);
      opacity: .55;
      animation: angelPulse 2.6s ease-in-out infinite;
      pointer-events: none;
    }

    /* â€œç¾½æ„Ÿâ€ã®å·¦å³ãƒ•ãƒ¬ã‚¢ï¼ˆç”»åƒãªã—ã§ç¾½ã£ã½ãï¼‰ */
    #btnDraw::after {
      content: "";
      position: absolute;
      left: -26px;
      right: -26px;
      top: 50%;
      height: 34px;
      transform: translateY(-50%);
      background:
        radial-gradient(26px 18px at 0% 50%, rgba(255, 255, 255, .55), transparent 70%),
        radial-gradient(26px 18px at 100% 50%, rgba(255, 255, 255, .55), transparent 70%),
        linear-gradient(90deg, transparent, rgba(255, 255, 255, .22), transparent);
      filter: blur(1px);
      opacity: .55;
      pointer-events: none;
    }

    /* ãƒ›ãƒãƒ¼ã§ä¸Šå“ã«æµ®ã */
    #btnDraw:hover {
      transform: translateY(-1px) scale(1.01);
      filter: saturate(1.03);
      box-shadow:
        0 18px 38px rgba(0, 0, 0, .32),
        0 0 0 1px rgba(255, 255, 255, .22) inset,
        0 0 26px rgba(255, 220, 150, .35);
    }

    /* æŠ¼ã—ãŸç¬é–“ã«â€œã‚­ãƒ©ãƒƒâ€ */
    #btnDraw:active {
      transform: translateY(0px) scale(.99);
      box-shadow:
        0 12px 24px rgba(0, 0, 0, .28),
        0 0 0 1px rgba(255, 255, 255, .20) inset,
        0 0 34px rgba(255, 245, 210, .55);
    }

    /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã§ã‚‚å…‰ã‚‹ */
    #btnDraw:focus-visible {
      outline: none;
      box-shadow:
        0 18px 38px rgba(0, 0, 0, .32),
        0 0 0 3px rgba(255, 245, 214, .55),
        0 0 40px rgba(255, 220, 150, .35);
    }

    @keyframes angelPulse {

      0%,
      100% {
        opacity: .45;
        transform: scale(1);
      }

      50% {
        opacity: .78;
        transform: scale(1.02);
      }
    }

    /* å…¬é–‹ç”¨ï¼šä¸Šã®æ“ä½œãƒ‘ãƒãƒ«ã‚’å…¨æ¶ˆã— */
    .topGrid {
      display: none !important;
    }

    /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã¨çµæœã®é–“ã«ç½®ãæ“ä½œãƒãƒ¼ */
    .drawBar {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-top: 14px;
      margin-bottom: 10px;
    }

    /* å¼•ãæ–¹ã‚’æ¨ªä¸¦ã³ä¸­å¤®ã« */
    .drawModeInline {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }

    /* ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€ãƒœã‚¿ãƒ³ï¼šä¸­å¤®å›ºå®šï¼†ä¸Šå“ã« */
    .drawBtn {
      min-width: min(520px, 92vw);
      padding: 16px 22px;
      border-radius: 999px;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .04em;
      cursor: pointer;
      border: 1px solid rgba(255, 255, 255, .35);
      color: rgba(40, 28, 10, .95);

      /* ãƒ™ãƒ¼ã‚¸ãƒ¥ç³»ã‚´ãƒ¼ãƒ«ãƒ‰ */
      background: linear-gradient(135deg,
          #f7e7c2 0%,
          #e6c37a 35%,
          #f6e4b6 60%,
          #cfa24f 100%);

      box-shadow:
        0 14px 34px rgba(0, 0, 0, .35),
        0 0 26px rgba(255, 224, 160, .28);
      position: relative;
      overflow: hidden;
    }

    /* ãµã‚ã£ã¨å…‰ã‚‹ */
    .drawBtn::before {
      content: "";
      position: absolute;
      inset: -60%;
      background: radial-gradient(circle at 30% 30%,
          rgba(255, 255, 255, .75),
          rgba(255, 255, 255, .15),
          transparent 60%);
      transform: rotate(12deg);
      animation: drawShine 2.6s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes drawShine {
      0% {
        transform: translateX(-14%) rotate(12deg);
        opacity: .35;
      }

      50% {
        transform: translateX(12%) rotate(12deg);
        opacity: .75;
      }

      100% {
        transform: translateX(-14%) rotate(12deg);
        opacity: .35;
      }
    }

    .drawBtn:hover {
      transform: translateY(-1px);
      filter: saturate(1.05);
    }

    .drawBtn:active {
      transform: translateY(0px) scale(.99);
    }

    /* =========================================
       âœ¨ Cinematic UI CSS Port 
       ========================================= */
    :root {
      --bg: #666132;
      --text: #ffffff;
      /* æ–‡å­—ã¯ç™½ç³»ã« */
      --muted: rgba(231, 206, 233, 0.72);
      /* è£œåŠ©æ–‡å­— */
      --line: rgba(133, 45, 45, 0.14);
      --accent: #f0abfc;
      /* å¤©ä½¿ãƒ”ãƒ³ã‚¯ */
      --accent2: #a5b4fc;
      /* ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼ */
      --good: #86efac;
      --warn: #fde68a;
      --bad: #fda4af;
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      background:
        linear-gradient(rgba(14, 11, 22, .62), rgba(14, 11, 22, .62)),
        url("public/bg/angel_bg1.webp") center / cover no-repeat,
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .panel {
      background: rgba(20, 16, 30, .62);
      /* åŠé€æ˜ã®é—‡ */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, .25);
      border-radius: 18px;
      padding: 14px;
      box-shadow:
        0 14px 40px rgba(0, 0, 0, .45),
        inset 0 0 0 1px rgba(255, 255, 255, .12);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .12);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      transition: transform .12s ease, background .12s ease;
    }

    .chip:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .08);
    }

    .chip input {
      accent-color: var(--accent);
      margin: 0;
    }

    .chip strong {
      font-size: 13px;
    }

    .chip span {
      font-size: 12px;
      color: var(--muted);
    }

    body,
    .panel,
    .tcard,
    .stage,
    header,
    .status,
    .small,
    .empty {
      text-shadow:
        0 1px 2px rgba(0, 0, 0, .55),
        0 0 6px rgba(0, 0, 0, .35);
    }

    /* Summary Block Text Only (Card style is overridden in Depth Polish) */
    .summaryTitle {
      font-weight: bold;
      color: var(--accent, #f0abfc);
      margin-bottom: 4px;
    }

    .summaryText {
      font-size: 13px;
      color: rgba(255, 255, 255, .85);
      margin-bottom: 4px;
    }

    /* =========================================
       âœ¨ Depth + Reverse lock (Cinematic, stable)
       - Fix reversed-card spinning on hover/scroll
       - Enhance depth without heavy blur
       ========================================= */

    :root {
      --glass: rgba(18, 14, 28, .62);
      --edge: rgba(255, 255, 255, .16);
      --edgeHi: rgba(240, 171, 252, .22);
      --glow: rgba(170, 190, 255, .12);
      --shadowDeep: rgba(0, 0, 0, .58);
      --shadowMid: rgba(0, 0, 0, .34);
      --lift: -2px;
    }

    /* Panels: deeper, more premium */
    .panel,
    .stage,
    .summaryCard {
      background: var(--glass);
      border: 1px solid rgba(255, 255, 255, .18);
      box-shadow:
        0 22px 64px var(--shadowDeep),
        0 2px 14px var(--glow),
        inset 0 1px 0 rgba(255, 255, 255, .12),
        inset 0 0 0 1px rgba(255, 255, 255, .06);
    }

    .summaryCard {
      background: rgba(255, 255, 255, .05);
      border: 1px solid rgba(255, 255, 255, .14);
    }

    /* =========================
       Card stability core
       - Do NOT overwrite transform per-state.
       - Compose rotation + lift via CSS variables.
       ========================= */

    .tcard {
      /* default (upright) */
      --rot: 0deg;
      --ty: 0px;

      position: relative;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .02);
      box-shadow:
        0 18px 52px rgba(0, 0, 0, .46),
        0 1px 0 rgba(255, 255, 255, .06),
        inset 0 1px 0 rgba(255, 255, 255, .10);

      /* IMPORTANT: always keep rotate in transform */
      transform: translateY(var(--ty)) rotate(var(--rot)) translateZ(0);
      transform-origin: center center;

      transition:
        transform .18s ease,
        box-shadow .18s ease,
        border-color .18s ease,
        filter .18s ease;
      will-change: transform;
    }

    /* Premium rim highlight (lightweight) */
    .tcard::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg,
          rgba(240, 171, 252, .26),
          rgba(165, 180, 252, .16),
          rgba(255, 255, 255, .06));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
      pointer-events: none;
      opacity: .72;
    }

    /* Optional subtle sheen */
    .tcard::after {
      content: "";
      position: absolute;
      left: 10%;
      top: 6%;
      width: 65%;
      height: 40%;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%,
          rgba(255, 255, 255, .10),
          rgba(255, 255, 255, 0) 70%);
      pointer-events: none;
      opacity: .55;
    }

    /* Reversed state lock:
       - match your existing reversed selector(s) by including multiple possibilities
       - keeps rotation stable on hover/scroll
    */
    .tcard.isReversed,
    .tcard.reversed,
    .tcard[data-reversed="true"],
    .tcard[aria-label*="é€†"],
    .tcard[aria-label*="reversed"] {
      --rot: 180deg;
    }

    /* Hover lift: change only --ty, never replace transform */
    .tcard:hover {
      --ty: var(--lift);
      border-color: rgba(255, 255, 255, .18);
      box-shadow:
        0 26px 74px rgba(0, 0, 0, .56),
        0 6px 18px rgba(160, 200, 255, .10),
        inset 0 1px 0 rgba(255, 255, 255, .12);
    }

    /* Image depth: follow the same lift (no rotation), avoid â€œspinâ€ */
    .cardImg {
      transform: translateY(var(--ty)) translateZ(0);
      filter: drop-shadow(0 16px 40px rgba(0, 0, 0, .58));
      transition: transform .18s ease, filter .18s ease;
      will-change: transform;
    }

    .tcard:hover .cardImg {
      filter: drop-shadow(0 26px 60px rgba(0, 0, 0, .68));
    }

    /* Buttons: premium depth without flash */
    button {
      box-shadow:
        0 14px 38px rgba(0, 0, 0, .28),
        inset 0 1px 0 rgba(255, 255, 255, .22);
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      filter: saturate(1.04) contrast(1.02);
      box-shadow:
        0 18px 46px rgba(0, 0, 0, .32),
        inset 0 1px 0 rgba(255, 255, 255, .24);
    }

    /* Chips: tiny lift only */
    .chip {
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .14);
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, .10),
        0 8px 22px rgba(0, 0, 0, .18);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }

    .chip:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .08);
      border-color: rgba(255, 255, 255, .16);
    }

    /* Accessibility / motion safety */
    @media (prefers-reduced-motion: reduce) {

      .tcard,
      .cardImg,
      button,
      .chip {
        transition: none !important;
      }

      .tcard:hover {
        --ty: 0px;
      }

      button:hover {
        transform: none;
      }

      .chip:hover {
        transform: none;
      }
    }

    /* =========================================
   ğŸ’ Premium micro-polish (no extra motion)
   - Lift perceived luxury via edges + tone
   - Keep reversed lock stable
   ========================================= */

    /* Panels: add subtle inner vignette + sharper edge */
    .panel,
    .stage,
    .summaryCard {
      background:
        radial-gradient(120% 140% at 10% 0%,
          rgba(255, 255, 255, .06),
          rgba(255, 255, 255, 0) 55%),
        radial-gradient(120% 140% at 90% 100%,
          rgba(0, 0, 0, .25),
          rgba(0, 0, 0, 0) 60%),
        var(--glass);
      border-color: rgba(255, 255, 255, .16);
    }

    /* Cards: refine depth stacking (more â€œcinema lensâ€ feel) */
    .tcard {
      box-shadow:
        0 22px 70px rgba(0, 0, 0, .52),
        /* deep */
        0 6px 18px rgba(0, 0, 0, .22),
        /* mid */
        inset 0 1px 0 rgba(255, 255, 255, .10);
      border-color: rgba(255, 255, 255, .12);
    }

    /* Rim highlight: slightly more premium, less â€œneonâ€ */
    .tcard::before {
      opacity: .62;
      background: linear-gradient(135deg,
          rgba(240, 171, 252, .22),
          rgba(165, 180, 252, .14),
          rgba(255, 255, 255, .05));
    }

    /* Sheen: narrower and softer (feels like coated paper) */
    .tcard::after {
      left: 12%;
      top: 7%;
      width: 58%;
      height: 34%;
      opacity: .45;
    }

    /* Hover: keep motion same, only enrich shadow tone */
    .tcard:hover {
      box-shadow:
        0 30px 86px rgba(0, 0, 0, .60),
        0 10px 22px rgba(160, 200, 255, .08),
        inset 0 1px 0 rgba(255, 255, 255, .12);
    }

    /* Card image: richer â€œpresenceâ€ without scaling more */
    .cardImg {
      filter:
        drop-shadow(0 18px 44px rgba(0, 0, 0, .62)) drop-shadow(0 2px 8px rgba(160, 200, 255, .08));
    }

    .tcard:hover .cardImg {
      filter:
        drop-shadow(0 30px 70px rgba(0, 0, 0, .70)) drop-shadow(0 3px 10px rgba(160, 200, 255, .10));
    }

    /* Buttons: edge definition + quieter glow */
    button {
      border: 1px solid rgba(255, 255, 255, .14);
      box-shadow:
        0 16px 44px rgba(0, 0, 0, .30),
        0 2px 10px rgba(160, 200, 255, .08),
        inset 0 1px 0 rgba(255, 255, 255, .20);
    }

    button:hover {
      box-shadow:
        0 20px 54px rgba(0, 0, 0, .34),
        0 3px 12px rgba(160, 200, 255, .10),
        inset 0 1px 0 rgba(255, 255, 255, .22);
    }

    /* Chips: make them feel â€œenamelâ€ */
    .chip {
      border-color: rgba(255, 255, 255, .12);
      background: linear-gradient(to bottom,
          rgba(255, 255, 255, .08),
          rgba(255, 255, 255, .04));
    }

    .chip:hover {
      background: linear-gradient(to bottom,
          rgba(255, 255, 255, .10),
          rgba(255, 255, 255, .05));
    }

    /* =========================================
   ğŸŒ™ Depth boost (Visible, still restrained)
   - Stronger contact shadow + double edge
   - No extra motion, no heavy blur
   ========================================= */

    :root {
      --contact: rgba(0, 0, 0, .72);
      --rimOuter: rgba(255, 255, 255, .14);
      --rimInner: rgba(255, 255, 255, .06);
      --glint: rgba(240, 171, 252, .18);
      --cool: rgba(165, 180, 252, .12);
    }

    /* Panels: add subtle inner frame (luxury â€œcaseâ€ feel) */
    .panel,
    .stage,
    .summaryCard {
      position: relative;
      box-shadow:
        0 26px 80px rgba(0, 0, 0, .62),
        0 2px 14px rgba(160, 200, 255, .10),
        inset 0 1px 0 rgba(255, 255, 255, .12),
        inset 0 0 0 1px rgba(255, 255, 255, .06);
    }

    /* Cards: contact shadow (the biggest â€œI can see itâ€ upgrade) */
    .tcard {
      background:
        linear-gradient(to bottom,
          rgba(255, 255, 255, .035),
          rgba(255, 255, 255, .012));
      border-color: var(--rimOuter);
      box-shadow:
        0 10px 22px rgba(0, 0, 0, .26),
        /* ambient */
        0 28px 72px rgba(0, 0, 0, .58),
        /* deep */
        0 2px 0 rgba(255, 255, 255, .05),
        /* top crisp */
        inset 0 1px 0 rgba(255, 255, 255, .10);
    }

    /* Inner edge line: makes it feel â€œmachined / framedâ€ */
    .tcard {
      outline: 1px solid rgba(255, 255, 255, .04);
      outline-offset: -6px;
    }

    /* Rim gradient slightly clearer (still not neon) */
    .tcard::before {
      opacity: .70;
      background: linear-gradient(135deg,
          var(--glint),
          var(--cool),
          rgba(255, 255, 255, .05));
    }

    /* Add a soft base shadow that reads as â€œseatedâ€ even without hover */
    .tcard::after {
      /* keep your sheen, but add base depth using multiple backgrounds */
      background:
        radial-gradient(circle at 30% 30%,
          rgba(255, 255, 255, .10),
          rgba(255, 255, 255, 0) 70%),
        radial-gradient(90% 120% at 50% 120%,
          rgba(0, 0, 0, .36),
          rgba(0, 0, 0, 0) 60%);
      opacity: .55;
    }

    /* Hover: same lift, but stronger â€œseparationâ€ */
    .tcard:hover {
      box-shadow:
        0 12px 26px rgba(0, 0, 0, .28),
        0 38px 98px rgba(0, 0, 0, .66),
        0 8px 22px rgba(160, 200, 255, .10),
        inset 0 1px 0 rgba(255, 255, 255, .12);
    }

    /* Image: give a tighter contact shadow + a halo */
    .cardImg {
      filter:
        drop-shadow(0 10px 18px var(--contact)) drop-shadow(0 26px 62px rgba(0, 0, 0, .62)) drop-shadow(0 2px 10px rgba(160, 200, 255, .10));
    }

    /* Buttons: add subtle bevel feel */
    button {
      border-color: rgba(255, 255, 255, .16);
      background:
        linear-gradient(to bottom,
          rgba(255, 255, 255, .10),
          rgba(255, 255, 255, .04));
      box-shadow:
        0 18px 54px rgba(0, 0, 0, .34),
        inset 0 1px 0 rgba(255, 255, 255, .22),
        inset 0 -1px 0 rgba(0, 0, 0, .25);
    }

    button:active {
      transform: translateY(0px);
      filter: saturate(1.02) contrast(1.01);
      box-shadow:
        0 10px 34px rgba(0, 0, 0, .28),
        inset 0 1px 0 rgba(255, 255, 255, .18),
        inset 0 -1px 0 rgba(0, 0, 0, .30);
    }

    /* Chips: more depth via crisp edge + tiny outer shadow */
    .chip {
      box-shadow:
        0 10px 24px rgba(0, 0, 0, .22),
        inset 0 1px 0 rgba(255, 255, 255, .12);
    }

    /* =========================================
   âœ¨ Typography + Detail polish (Luxury, calm)
   - Improve readability and â€œgradeâ€
   - No extra motion, no blur
   ========================================= */

    :root {
      --textA: rgba(255, 255, 255, .92);
      --textB: rgba(255, 255, 255, .78);
      --textC: rgba(255, 255, 255, .62);
    }

    /* Global text tuning: subtle contrast and spacing */
    body {
      color: var(--textA);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Panels: give inner padding feel via subtle highlight line */
    .panel,
    .stage,
    .summaryCard {
      border-color: rgba(255, 255, 255, .15);
    }

    /* Make important headings feel â€œpremiumâ€ */
    h1,
    h2,
    h3,
    .title,
    .heading {
      letter-spacing: .04em;
    }

    /* If your app uses these blocks, it will instantly improve hierarchy */
    .summaryCard,
    .panel {
      color: var(--textB);
    }

    .summaryCard strong,
    .panel strong,
    .summaryCard b,
    .panel b {
      color: var(--textA);
    }

    /* Chips: cleaner labels */
    .chip {
      color: var(--textB);
      letter-spacing: .04em;
    }

    /* Buttons: text clarity */
    button {
      letter-spacing: .04em;
      color: var(--textA);
    }

    /* Cards: make text around cards more readable */
    .tcard {
      color: var(--textA);
    }

    /* Optional: if you have captions/labels under cards */
    .caption,
    .label,
    .meta,
    .subtext {
      color: var(--textC);
      letter-spacing: .03em;
    }

    /* Reduce â€œbusyâ€ feeling by tightening focus styles */
    :focus-visible {
      outline: 2px solid rgba(240, 171, 252, .35);
      outline-offset: 2px;
      border-radius: 12px;
    }

    /* =========================================
   âœ¨ Text block finisher (Readability = Luxury)
   - No motion, no blur
   ========================================= */

    /* Long-form text: calm, cinematic readability */
    .panel p,
    .stage p,
    .summaryCard p,
    .panel .reasonText,
    .panel .energyText,
    .stage .reasonText,
    .stage .energyText {
      line-height: 1.85;
      letter-spacing: .02em;
      color: rgba(255, 255, 255, .82);
    }

    /* If your reason/energy blocks are dense, add breathing room */
    .panel .reasonText,
    .panel .energyText,
    .stage .reasonText,
    .stage .energyText {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, .08);
    }

    /* Make emphasized parts feel intentional (not shouty) */
    .panel strong,
    .stage strong,
    .summaryCard strong,
    .panel b,
    .stage b,
    .summaryCard b {
      color: rgba(255, 255, 255, .93);
      font-weight: 600;
    }

    /* Reduce â€œflat wall of textâ€ feeling */
    .panel,
    .stage,
    .summaryCard {
      max-width: 980px;
      /* if container allows, it looks premium */
    }

    /* =========================================
   ğŸŒ Responsive center layout (PC + Mobile)
   ========================================= */

    /* Outer spacing */
    body {
      padding-inline: 16px;
    }

    /* Main containers */
    .panel,
    .stage,
    .summaryCard {
      width: 100%;
      max-width: 980px;
      margin-inline: auto;
    }

    /* Give breathing space on large screens */
    @media (min-width: 1200px) {
      body {
        padding-inline: 32px;
      }

      .panel,
      .stage,
      .summaryCard {
        max-width: 1100px;
      }
    }

    /* Mobile tuning */
    @media (max-width: 640px) {
      body {
        padding-inline: 14px;
      }

      .panel,
      .stage,
      .summaryCard {
        max-width: 100%;
      }
    }

    /* =========================================
   âœ¨ Final tuning (Luxury + Stability)
   - Reversed clarity without motion
   - Disable hover on touch devices
   ========================================= */

    /* =========================================
       ğŸŒŸ Reversed marker (safe, visible, premium)
       - Uses ::before only (keeps ::after sheen intact)
       ========================================= */

    /* Add a tiny corner glint INSIDE the rim gradient for reversed cards */
    .tcard.isReversed::before,
    .tcard.reversed::before,
    .tcard[data-reversed="true"]::before,
    .tcard[aria-label*="é€†"]::before,
    .tcard[aria-label*="reversed"]::before {
      background:
        /* corner glint (top-right) */
        radial-gradient(14px 14px at 92% 10%,
          rgba(255, 255, 255, .22),
          rgba(255, 255, 255, 0) 70%),
        /* keep existing rim look */
        linear-gradient(135deg,
          rgba(165, 180, 252, .22),
          rgba(160, 200, 255, .14),
          rgba(255, 255, 255, .05));
      opacity: .74;
      filter: none;
      /* prevent hue-rotate from muddying the glint */
    }

    /* Keep border color cue (quiet, clear) */
    .tcard.isReversed,
    .tcard.reversed,
    .tcard[data-reversed="true"],
    .tcard[aria-label*="é€†"],
    .tcard[aria-label*="reversed"] {
      border-color: rgba(165, 180, 252, .26);
    }

    /* 2) Hover effects only for devices that actually hover (PC/mouse) */
    @media (hover: hover) and (pointer: fine) {
      .tcard:hover {
        --ty: var(--lift);
      }

      .chip:hover {
        transform: translateY(-1px);
      }

      button:hover {
        transform: translateY(-1px);
      }
    }

    /* Touch devices: kill hover transforms to prevent â€œstuck hoverâ€ */
    @media (hover: none) and (pointer: coarse) {
      .tcard:hover {
        --ty: 0px;
      }

      .chip:hover {
        transform: none;
      }

      button:hover {
        transform: none;
      }
    }

    /* =========================================
   ğŸ¬ Background lighting (shadow visibility fix)
   ========================================= */

    :root {
      --bg0: #070914;
      --bg1: #0b0f1c;

      --textA: rgba(255, 255, 255, .92);
      --textB: rgba(255, 255, 255, .78);
      --textC: rgba(255, 255, 255, .62);

      --surface: rgba(18, 14, 28, .62);
    }

    /* Cinematic background lighting */
    body {
      background:
        radial-gradient(120% 100% at 50% 0%,
          rgba(245, 230, 179, .08),
          rgba(0, 0, 0, 0) 60%),
        radial-gradient(80% 70% at 90% 20%,
          rgba(214, 178, 94, .06),
          rgba(0, 0, 0, 0) 60%),
        linear-gradient(to bottom,
          #11111d 0%,
          #15152b 60%,
          #0c0c18 100%);
      background-attachment: fixed;
      color: #f2f2f2;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      /* ã†ã£ã™ã‚‰ç²’å­ï¼ˆCSSã ã‘ã§æ“¬ä¼¼ãƒã‚¤ã‚ºï¼‰ */
      background:
        repeating-linear-gradient(0deg,
          rgba(255, 255, 255, .03) 0px,
          rgba(255, 255, 255, .03) 1px,
          rgba(0, 0, 0, 0) 2px,
          rgba(0, 0, 0, 0) 4px);
      opacity: .06;
      mix-blend-mode: overlay;
      z-index: 0;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      /* ä¸Šå“ãªãƒ“ãƒãƒƒãƒˆï¼ˆä¸­å¿ƒã«è¦–ç·šãŒé›†ã¾ã‚‹ï¼‰ */
      background: radial-gradient(120% 120% at 50% 50%,
          rgba(0, 0, 0, 0) 45%,
          rgba(0, 0, 0, .38) 100%);
      opacity: .55;
      z-index: 0;
    }

    /* æ—¢å­˜UIãŒä¸Šã«æ¥ã‚‹ã‚ˆã†ã«ï¼ˆå®‰å…¨ï¼‰ */
    .app,
    .panel,
    .stage,
    .summaryCard {
      position: relative;
      z-index: 1;
    }

    /* Panels: slightly brighter than background */
    .panel,
    .stage,
    .summaryCard {
      background:
        linear-gradient(to bottom,
          rgba(255, 255, 255, .05),
          rgba(255, 255, 255, .018)),
        var(--surface);
      border-color: rgba(255, 255, 255, .14);
    }

    /* Cards: make them read as objects (clear separation) */
    .tcard {
      background:
        radial-gradient(120% 80% at 50% 0%,
          rgba(255, 255, 255, .06),
          rgba(255, 255, 255, 0) 55%),
        linear-gradient(to bottom,
          rgba(255, 255, 255, .032),
          rgba(255, 255, 255, .012));
    }

    /* =========================================
   âœ¨ Readability scale adjustment
   ========================================= */

    /* Base size slightly larger */
    html {
      font-size: 17px;
      /* default 16 â†’ 17 */
    }

    /* Long text blocks */
    .panel p,
    .stage p,
    .summaryCard p,
    .reasonText,
    .energyText {
      font-size: 1.05rem;
      line-height: 1.9;
    }

    /* Headings slightly stronger hierarchy */
    h1 {
      font-size: 1.6rem;
    }

    h2 {
      font-size: 1.3rem;
    }

    h3 {
      font-size: 1.15rem;
    }

    /* Mobile tuning */
    @media (max-width: 640px) {
      html {
        font-size: 16.5px;
      }

      .panel p,
      .stage p,
      .summaryCard p,
      .reasonText,
      .energyText {
        font-size: 1.08rem;
        line-height: 1.95;
      }
    }

    /* =========================================
   ğŸ” Real readability upgrade (visible change)
   ========================================= */

    /* Stronger base scale */
    html {
      font-size: 18.5px;
    }

    /* Long-form reading text */
    .panel p,
    .stage p,
    .summaryCard p,
    .reasonText,
    .energyText {
      font-size: 1.08rem;
      line-height: 1.95;
      letter-spacing: .015em;
    }

    /* Improve contrast (very important) */
    .panel,
    .stage,
    .summaryCard {
      color: rgba(255, 255, 255, .92);
    }

    .caption,
    .label,
    .meta,
    .subtext {
      color: rgba(255, 255, 255, .70);
    }

    /* Mobile: keep strong readability */
    @media (max-width: 640px) {
      html {
        font-size: 17.5px;
      }

      .panel p,
      .stage p,
      .summaryCard p,
      .reasonText,
      .energyText {
        font-size: 1.1rem;
        line-height: 2;
      }
    }

    /* =========================================
   ğŸ” Readability MAX (Long-text only, not UI)
   - Make reading text clearly larger
   - Keep buttons/chips from ballooning
   ========================================= */

    /* Keep current base (do not increase html further) */
    /* html{ font-size: 18.5px; }  â† ã“ã“ã¯æ—¢å­˜ã®ã¾ã¾ã§OK */

    /* Long-form reading text = the main upgrade */
    .panel p,
    .stage p,
    .summaryCard p,
    .reasonText,
    .energyText {
      font-size: clamp(1.16rem, 1.05rem + 0.6vw, 1.28rem);
      line-height: 2.05;
      letter-spacing: .012em;
    }

    /* Headings also slightly up so hierarchy stays elegant */
    h1 {
      font-size: clamp(1.75rem, 1.55rem + 0.8vw, 2.05rem);
    }

    h2 {
      font-size: clamp(1.35rem, 1.22rem + 0.5vw, 1.55rem);
    }

    h3 {
      font-size: clamp(1.18rem, 1.10rem + 0.35vw, 1.32rem);
    }

    /* Small UI text (chips/buttons) stays controlled */
    button,
    .chip {
      font-size: 0.98rem;
      line-height: 1.25;
    }

    /* Mobile: slightly stronger for readability */
    @media (max-width: 640px) {

      .panel p,
      .stage p,
      .summaryCard p,
      .reasonText,
      .energyText {
        font-size: 1.22rem;
        /* ~22px class */
        line-height: 2.10;
      }
    }

    /* =========================================
   ğŸ¯ Text targeting fix (Make body bigger, keep steps small)
   ========================================= */

    /* 1) Step/Process texts should NOT be huge (keep them refined) */
    .chip,
    button,
    .stage .chip,
    .panel .chip,
    .summaryCard .chip,
    .step,
    .steps,
    .hint,
    .help,
    .helper,
    .instructions,
    .instruction,
    .process,
    .status,
    .small,
    .muted,
    [role="status"],
    [aria-live] {
      font-size: 0.98rem !important;
      line-height: 1.35 !important;
      letter-spacing: .04em;
    }

    /* 2) Main reading text: make it clearly larger
   - target both <p> and "div-based" text blocks (br rendering) */
    .reasonText,
    .energyText,
    .resultText,
    .readingText,
    .panel .reasonText,
    .panel .energyText,
    .stage .reasonText,
    .stage .energyText,
    .summaryCard .reasonText,
    .summaryCard .energyText {
      font-size: clamp(1.20rem, 1.08rem + 0.7vw, 1.34rem) !important;
      line-height: 2.05 !important;
      letter-spacing: .012em;
    }

    /* 3) Fallback: if long text is inside generic containers, catch it safely */
    .panel :where(p, li, dd, td),
    .stage :where(p, li, dd, td),
    .summaryCard :where(p, li, dd, td) {
      font-size: clamp(1.16rem, 1.05rem + 0.6vw, 1.30rem) !important;
      line-height: 2.00 !important;
    }

    /* 4) But never inflate headings */
    .panel :where(h1, h2, h3),
    .stage :where(h1, h2, h3),
    .summaryCard :where(h1, h2, h3) {
      line-height: 1.25;
    }

    /* 5) Mobile: stronger readability */
    @media (max-width: 640px) {

      .reasonText,
      .energyText,
      .resultText,
      .readingText {
        font-size: 1.26rem !important;
        /* ~22pxç´š */
        line-height: 2.10 !important;
      }

      .chip,
      button,
      .instructions,
      .process {
        font-size: 1.00rem !important;
      }
    }

    /* =========================================
   ğŸ§ª Font debug + Force readable body text
   - Prove selector hit (debug highlight)
   - Make main reading text bigger for sure
   ========================================= */

    /* A) Debug: if you don't see this highlight on the main reading text,
      your selectors are missing the real nodes. */
    .reasonText,
    .energyText,
    .resultText,
    .readingText {
      background: rgba(255, 230, 140, .10) !important;
      /* debug */
      outline: 1px dashed rgba(255, 230, 140, .25) !important;
      /* debug */
    }

    /* B) Force: enlarge reading text broadly but avoid UI controls */
    :where(.panel, .stage, .summaryCard, #app, .app, main, body) :where(p, div, span, li, dd, td) {
      font-size: clamp(1.20rem, 1.06rem + 0.85vw, 1.38rem) !important;
      line-height: 2.05 !important;
      letter-spacing: .012em;
    }

    /* C) Do NOT enlarge typical UI bits */
    :where(button, .chip, input, textarea, select, option, label, small,
      .step, .steps, .hint, .help, .helper, .instructions, .instruction,
      .process, .status, .caption, .label, .meta, .subtext,
      [role="status"], [aria-live]) {
      font-size: 1.00rem !important;
      line-height: 1.35 !important;
    }

    /* D) If some container is forcing px sizes, neutralize it */
    :where(.panel, .stage, .summaryCard, #app, .app, main, body) {
      font-size: inherit !important;
    }

    /* E) Mobile: push reading size to clearly â€œbigâ€ */
    @media (max-width: 640px) {
      :where(.panel, .stage, .summaryCard, #app, .app, main, body) :where(p, div, span, li, dd, td) {
        font-size: 1.28rem !important;
        /* ~22â€“23pxç´š */
        line-height: 2.10 !important;
      }
    }

    /* =========================================
   âœ… Font scope fix (Body-only bigger, UI/icons normal)
   - Neutralize the global force rules
   ========================================= */

    /* 1) Reset global forced enlargement (stop affecting everything) */
    :where(#app, .app, main, body) :where(p, div, span, li, dd, td) {
      font-size: inherit !important;
      line-height: inherit !important;
      letter-spacing: inherit !important;
      background: transparent !important;
      /* remove debug yellow */
      outline: none !important;
      /* remove debug outline */
    }

    /* 2) Keep UI elements at normal size */
    :where(button, .chip, input, textarea, select, option, label, small,
      .step, .steps, .hint, .help, .helper, .instructions, .instruction,
      .process, .status, .caption, .label, .meta, .subtext,
      [role="status"], [aria-live]) {
      font-size: 1rem !important;
      line-height: 1.35 !important;
    }

    /* 3) Icons: prevent icon fonts from scaling up */
    :where(.icon, .icons, .material-icons, .material-symbols-outlined,
      .fa, .fas, .far, .fab, .bi) {
      font-size: 1em !important;
      line-height: 1 !important;
    }

    svg {
      width: 1em;
      height: 1em;
    }

    /* 4) Make ONLY reading text bigger (safe scope: panels/stage/summary) */
    :where(.panel, .stage, .summaryCard) :where(.reasonText, .energyText, .resultText, .readingText) {
      font-size: clamp(1.20rem, 1.08rem + 0.7vw, 1.34rem) !important;
      line-height: 2.05 !important;
      letter-spacing: .012em;
    }

    /* 5) Fallback: if main text is plain <p> in those containers */
    :where(.panel, .stage, .summaryCard) p {
      font-size: clamp(1.16rem, 1.05rem + 0.6vw, 1.30rem) !important;
      line-height: 2.00 !important;
    }

    /* 6) Mobile: strong readability only for reading text */
    @media (max-width: 640px) {
      :where(.panel, .stage, .summaryCard) :where(.reasonText, .energyText, .resultText, .readingText) {
        font-size: 1.26rem !important;
        /* ~22pxç´š */
        line-height: 2.10 !important;
      }

      :where(.panel, .stage, .summaryCard) p {
        font-size: 1.22rem !important;
        line-height: 2.08 !important;
      }
    }

    /* =========================================
       âœ¨ Animations & Glows (Luxury Polish)
       ========================================= */
    .result-animate {
      opacity: 0;
      transform: translateY(12px);
      filter: blur(4px);
      transition: opacity .6s cubic-bezier(0.22, 1, 0.36, 1),
        transform .6s cubic-bezier(0.22, 1, 0.36, 1),
        filter .6s cubic-bezier(0.22, 1, 0.36, 1);
    }

    .result-animate.show {
      opacity: 1;
      transform: translateY(0);
      filter: blur(0);
    }

    @media (prefers-reduced-motion: reduce) {
      .result-animate {
        transition: none;
        opacity: 1;
        transform: none;
        filter: none;
      }
    }

    .tcard {
      position: relative;
      z-index: 1;
    }

    .tcard::before {
      content: "";
      position: absolute;
      inset: -20px;
      border-radius: 20px;
      background: radial-gradient(circle at center,
          rgba(255, 215, 120, .18),
          rgba(255, 215, 120, 0) 70%);
      filter: blur(18px);
      z-index: -1;
      pointer-events: none;
    }

    @media (max-width: 520px) {
      .cardsGrid.three .kwWrap {
        display: grid !important;
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        gap: 6px !important;
      }

      .cardsGrid.three .kw {
        font-size: 11px !important;
        padding: 5px 8px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        max-width: 100% !important;
      }
    }

    /* Draw mode active highlight */
    .drawModeInline input[name="drawMode"]:checked+div {
      border: 1px solid rgba(214, 178, 94, 0.8) !important;
      background: rgba(214, 178, 94, 0.15) !important;
      box-shadow: 0 0 12px rgba(214, 178, 94, 0.4);
    }

    /* Antigravity Hover Effect */
    @keyframes antigravityFloat {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .antigravity .tcard {
      animation: antigravityFloat 4s ease-in-out infinite;
    }

    .antigravity .tcard:nth-child(2) {
      animation-delay: 0.6s;
    }

    .antigravity .tcard:nth-child(3) {
      animation-delay: 1.2s;
    }

    @media (prefers-reduced-motion: reduce) {
      .antigravity .tcard {
        animation: none;
      }
    }

    /* =========================================
       âœ¨ Toast & Share UI
       ========================================= */
    #toastContainer {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 10000;
      pointer-events: none;
    }

    .toast {
      background: rgba(20, 16, 30, .85);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, .25);
      color: rgba(255, 255, 255, .95);
      padding: 12px 24px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .45);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      white-space: nowrap;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      .toast {
        transition: none;
      }
    }

    /* Result Actions (Share Block, Draw Again) */
    .resultActions {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(255, 255, 255, .1);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.6s ease 0.3s, transform 0.6s ease 0.3s;
    }

    .result-animate.show .resultActions {
      opacity: 1;
      transform: translateY(0);
    }

    .shareTitle {
      font-size: 13px;
      color: var(--muted);
      letter-spacing: .1em;
      text-transform: uppercase;
    }

    .shareRow {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btnGhost {
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .15);
      color: rgba(255, 255, 255, .85);
      padding: 10px 18px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btnGhost:hover {
      background: rgba(255, 255, 255, .1);
      border-color: rgba(255, 255, 255, .3);
      color: white;
    }

    .btnDrawAgain {
      background: linear-gradient(135deg, rgba(214, 178, 94, .15), rgba(214, 178, 94, .05));
      border: 1px solid rgba(214, 178, 94, .3);
      color: #efd39a;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s ease;
    }

    .btnDrawAgain:hover {
      background: linear-gradient(135deg, rgba(214, 178, 94, .25), rgba(214, 178, 94, .1));
      border-color: rgba(214, 178, 94, .5);
      color: #fff;
    }

    .numerologyLink {
      display: inline-block;
      margin-top: 24px;
      font-size: 12px;
      color: var(--muted);
      text-decoration: none;
      border-bottom: 1px solid rgba(255, 255, 255, .15);
      padding-bottom: 2px;
      transition: color 0.2s;
    }

    .numerologyLink:hover {
      color: #fff;
      border-color: rgba(255, 255, 255, .4);
    }
  </style>
</head>

<body>
  <div id="versionBadge" style="position:fixed;bottom:12px;right:12px;z-index:9999;
background:#000a;border:1px solid #fff3;color:#fff;padding:8px 10px;border-radius:10px;
font:12px/1.2 ui-sans-serif;">
    VERSION:
  </div>

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <div class="app">
    <header>
      <div class="title">
        <h1>Angelique Tarot</h1>
        <p>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰10å€‹ / ï¼ˆã‚³ã‚¢ãƒ»æ³¨é‡ˆãƒ»å¤©ä½¿ï¼‰/ Yesãƒ»Noï¼ˆæ­£é€†ï¼‰ã‚’è¡¨ç¤ºã€‚</p>
      </div>
    </header>

    <div class="panel topGrid">
      <div>
        <div id="creatorOnly"></div>
        <div class="fileBox" id="csvArea">

          <div>
            <input id="csvFile" type="file" accept=".csv,text/csv" />
            <div class="hint">

            </div>
          </div>
          <div style="margin-left:auto; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="secondary" id="btnUseSaved">ä¿å­˜æ¸ˆã¿CSVã‚’ä½¿ã†</button>
            <button class="secondary" id="btnClearSaved">ä¿å­˜ã‚’æ¶ˆã™</button>
          </div>
        </div>
        <div class="status" id="status"> Angelique Tarot ã¯ã™ãã«ä½¿ãˆã¾ã™ âœ¨</div>
      </div>
    </div>

    <div>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <div style="font-weight:800; font-size:14px;">â‘¡ å¼•ãæ–¹ã‚’é¸ã¶</div>

        <div class="drawMode">
          <label class="chip">
            <input type="radio" name="drawMode" value="1" checked />
            <div>
              <strong>1æšï¼ˆãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«ï¼‰</strong><br />
              <span>ã„ã¾ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</span>
            </div>
          </label>

          <label class="chip">
            <input type="radio" name="drawMode" value="3" />
            <div>
              <strong>3æšï¼ˆæ·±æ˜ã‚Šï¼‰</strong><br />
              <span>éå» / ç¾åœ¨ / æœªæ¥</span>
            </div>
          </label>
          <label class="chip" style="cursor:text;">
            <div>
              <strong>ã‚ãªãŸã®ç”Ÿå¹´æœˆæ—¥</strong><br />
              <input type="date" id="userBirthdate"
                style="background:transparent; border:none; color:inherit; outline:none; font-family:inherit; margin-top:2px;" />
            </div>
          </label>
          <label class="chip" style="cursor:text;">
            <div>
              <strong>ãŠç›¸æ‰‹ã®ç”Ÿå¹´æœˆæ—¥</strong><br />
              <input type="date" id="partnerBirthdate"
                style="background:transparent; border:none; color:inherit; outline:none; font-family:inherit; margin-top:2px;" />
            </div>
          </label>
        </div>

        <div class="btnRow">

        </div>

        <div class="small">

        </div>
      </div>
    </div>
  </div>




  <div class="panel stage">
    <div class="stageTop">
      <div class="stageTitle">
        <h2>ã‚·ãƒ£ãƒƒãƒ•ãƒ«</h2>
        <p>æ¼”å‡º â†’ å¼•ã„ãŸçµæœã‚’è¡¨ç¤º</p>
      </div>
      <div class="small" id="deckInfo">ãƒ‡ãƒƒã‚­ï¼šæœªèª­ã¿è¾¼ã¿</div>
    </div>

    <!-- âœ… ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¡¨ç¤º -->
    <div class="shuffleArea" id="shuffleArea">
      <div class="deck"></div>
      <div class="fly"></div>
      <div class="fly"></div>
      <div class="fly"></div>
      <div class="fly"></div>
      <div class="fly"></div>
      <div class="fly"></div>
    </div>

    <!-- âœ… ãƒœã‚¿ãƒ³ï¼‹å¼•ãæ–¹ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ã¨çµæœã®é–“ï¼‰ -->
    <div class="drawBar">
      <button id="btnDraw" class="drawBtn">ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã</button>

      <div class="drawModeInline" aria-label="å¼•ãæ–¹">
        <label class="chip">
          <input type="radio" name="drawMode" value="1" checked />
          <div><strong>ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«ï¼ˆ1æšï¼‰</strong><br><span>ãƒ¯ãƒ³ã‚ªãƒ©ã‚¯ãƒ«</span></div>
        </label>

        <label class="chip">
          <input type="radio" name="drawMode" value="3" />
          <div><strong>3æšå¼•ãï¼ˆéå»/ç¾åœ¨/æœªæ¥ï¼‰</strong><br><span>éå» / ç¾åœ¨ / æœªæ¥</span></div>
        </label>
      </div>
    </div>

    <!-- âœ… çµæœè¡¨ç¤º -->
    <div id="result" class="antigravity" style="margin-top:14px;">
      <div class="empty">
        ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚<br>
        ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
      </div>
    </div>
  </div>



  <!-- æç”»ç”¨è¦‹ãˆãªã„Canvas -->
  <canvas id="shareCanvas" width="1080" height="1080" style="display:none;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const VERSION = "2026.03.01.1";

    // --- Toast functions ---
    function showToast(message, duration = 3000) {
      const container = document.getElementById("toastContainer");
      if (!container) return;
      const el = document.createElement("div");
      el.className = "toast";
      el.textContent = message;
      container.appendChild(el);

      // reflow
      void el.offsetWidth;
      el.classList.add("show");

      setTimeout(() => {
        el.classList.remove("show");
        el.addEventListener("transitionend", () => {
          if (el.parentNode) el.parentNode.removeChild(el);
        });
      }, duration);
    }




    function getCurrentDrawModeValue() {
      return document.querySelector('input[name="drawMode"]:checked')?.value || "1";
    }

    function updateDrawButtonLabels() {
      const btn = document.getElementById("btnDraw");
      if (btn) btn.textContent = "ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã";
    }

    function bindDrawModeLabelSync() {
      document.querySelectorAll('input[name="drawMode"]').forEach(r => {
        r.addEventListener("change", () => {
          if (r.checked) updateDrawButtonLabels();
        });
      });
    }

    function getYesNo(cardName, isReversed) {
      const neutralCards = [
        "ç¯€åˆ¶", "æœˆ", "åŠã‚‹ã•ã‚ŒãŸç”·", "éš è€…"
      ];

      if (neutralCards.includes(cardName)) return "ä¿ç•™";
      return isReversed ? "NO" : "YES";
    }

    function deriveThemeLabel(primaryCard, hasPartnerDate) {
      const pickedTheme = getSelectedTheme();
      if (pickedTheme) return pickedTheme;
      if (hasPartnerDate) return "æ‹æ„›";
      // æ—¢å­˜ã® isMoneyTheme ã‚’ä½¿ã†ï¼ˆå­˜åœ¨ã™ã‚‹å‰æã€‚ç„¡ã‘ã‚Œã°é‡‘é‹åˆ¤å®šã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
      try {
        if (typeof isMoneyTheme === "function" && isMoneyTheme(primaryCard?.themes, primaryCard?.name_ja || primaryCard?.name)) {
          return "é‡‘é‹";
        }
      } catch (_) { }
      return "ä»•äº‹";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const badge = document.getElementById("versionBadge");
      if (badge) badge.textContent = "VERSION: " + VERSION;
    });

    function scrollToResultSmooth() {
      const target = document.getElementById("result");
      if (!target) return;

      const reduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const behavior = reduce ? "auto" : "smooth";

      // æç”»ãŒå®Œäº†ã—ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆ2ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã¤ï¼‰
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          try {
            target.scrollIntoView({ behavior, block: "start" });
          } catch (_) {
            // å¤ã„ç’°å¢ƒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const top = target.getBoundingClientRect().top + window.pageYOffset - 8;
            window.scrollTo({ top, behavior });
          }
        });
      });
    }

    const STORAGE_KEY = "angelique_tarot_csv_rows_v2";
    let cards = [];
    const IS_CREATOR = location.hostname === "localhost" || location.hostname === "127.0.0.1";


    function applyCreatorMode() {
      const creator = document.getElementById("creatorOnly");
      const csvArea = document.getElementById("csvArea");

      if (!IS_CREATOR) {
        if (creator) creator.style.display = "none";
        if (csvArea) csvArea.style.display = "none"; // â˜… CSV UIå…¨ä½“ã‚’éš ã™
      }
    }




    const elFile = document.getElementById("csvFile");
    const elStatus = document.getElementById("status");
    const elDeckInfo = document.getElementById("deckInfo");
    const elShuffleArea = document.getElementById("shuffleArea");
    const elResult = document.getElementById("result");

    document.getElementById("btnDraw").addEventListener("click", onDraw);
    const btnUseSaved = document.getElementById("btnUseSaved");
    if (btnUseSaved) btnUseSaved.addEventListener("click", useSaved);

    const btnClearSaved = document.getElementById("btnClearSaved");
    if (btnClearSaved) btnClearSaved.addEventListener("click", clearSaved);

    if (elFile) elFile.addEventListener("change", onPickFile);

    const CSV_PATH = "public/data/deck.csv";

    function guessDelimiterFromText(text) {
      const firstLine = (text || "").split(/\r?\n/)[0] || "";
      const tabCount = (firstLine.match(/\t/g) || []).length;
      const commaCount = (firstLine.match(/,/g) || []).length;
      // ã‚¿ãƒ–ã®æ–¹ãŒå¤šã‘ã‚Œã°TSVã€ãã‚Œä»¥å¤–ã¯CSV
      return tabCount > commaCount ? "\t" : ",";
    }

    async function loadBundledCsv() {
      console.log("loadBundledCsv called");
      setStatus("åŒæ¢±CSVã‚’èª­ã¿è¾¼ã¿ä¸­...");
      console.log("CSV_PATH =", CSV_PATH);

      try {
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error(`fetch failed: ${res.status} ${res.statusText}`);
        const text = await res.text();

        const delim = guessDelimiterFromText(text);
        console.log("guessed delimiter =", JSON.stringify(delim));

        const results = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          delimiter: delim
        });


        // ===== Column1ã€œ è¡Œã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ =====
        if (results.meta?.fields?.[0]?.toLowerCase() === "column1") {
          console.log("Dummy header detected. Re-parsing CSV...");
          results.data.shift();              // ãƒ€ãƒŸãƒ¼è¡Œã‚’æ¨ã¦ã‚‹
        }
        // ========================================

        console.log("Papa meta.fields:", results.meta?.fields);
        console.log("First row sample:", results.data?.[0]);

        const rows = (results.data || [])
          .map(normalizeRow)
          .filter(r => r && r.id);


        console.log("normalized rows:", rows.length, rows[0]);

        if (!rows.length) {
          setStatus("åŒæ¢±CSVã®èª­ã¿è¾¼ã¿ã¯ã§ããŸãŒã€id ãŒå–ã‚Œã¾ã›ã‚“ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å/åŒºåˆ‡ã‚Šã®å¯èƒ½æ€§ï¼‰ã€‚");
          return;
        }

        if (!validateCards(rows)) {
          setStatus("åŒæ¢±CSVã®å¿…é ˆåˆ—ï¼ˆid,name_ja,name_en,imageï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
          return;
        }

        cards = rows;
        setDeckInfo();
        setStatus(`åŒæ¢±CSV èª­ã¿è¾¼ã¿å®Œäº†ï¼š${cards.length}æšã€‚å¼•ã‘ã¾ã™ã€‚`);
        showReady();
      } catch (e) {
        console.error(e);
        setStatus("åŒæ¢±CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆConsoleå‚ç…§ï¼‰ã€‚");
      }
    }


    function boot() {
      applyCreatorMode();
      loadBundledCsv();
    }
    boot();



    function setStatus(msg) { elStatus.textContent = msg; }
    function setDeckInfo() {
      elDeckInfo.textContent = cards.length ? `ãƒ‡ãƒƒã‚­ï¼š${cards.length}æš èª­ã¿è¾¼ã¿æ¸ˆã¿` : "ãƒ‡ãƒƒã‚­ï¼šæœªèª­ã¿è¾¼ã¿";
    }


    function pick(row, key) {
      // å®Œå…¨ä¸€è‡´
      if (row[key] != null) return row[key];

      // trim/BOMã‚’ç„¡è¦–ã—ã¦ä¸€è‡´ã•ã›ã‚‹
      const want = normalizeKey(key);
      const hit = Object.keys(row).find(k => normalizeKey(k) === want);
      return hit ? row[hit] : "";
    }

    function normalizeKey(s) {
      return (s ?? "")
        .toString()
        .replace(/^\uFEFF/, "")
        .trim()
        .toLowerCase();
    }





    function pickAny(row, candidates) {
      for (const c of candidates) {
        const v = pick(row, c);
        if (v != null && String(v).trim() !== "") return String(v).trim();
      }
      return "";
    }



    function normalizeImagePath(s) {
      return (s ?? "")
        .toString()
        .replace(/^\uFEFF/, "")
        .trim()
        .replace(/^\/+/, "")
        .replace(/\\/g, "/");   // Windowsã® \ ã‚’ / ã«
    }

    function normalizeRow(row) {
      // ã‚­ãƒ¼æ­£è¦åŒ–ï¼ˆBOM/ç©ºç™½/å¤§å°ï¼‰
      const norm = (s) => (s ?? "").toString().replace(/^\uFEFF/, "").trim().toLowerCase();

      // row ã‹ã‚‰ key ã‚’å¤§å°/BOMç„¡è¦–ã§å–ã‚‹
      const get = (key) => {
        const want = norm(key);
        const hit = Object.keys(row).find(k => norm(k) === want);
        return hit ? String(row[hit] ?? "").trim() : "";
      };

      // 1) é€šå¸¸ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆid, arcana, ... imageï¼‰ã§æ¥ãŸå ´åˆ
      const idNormal = get("id");
      if (idNormal) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡ŒãŒæ··ã˜ã‚‹ä¿é™º
        if (idNormal.toLowerCase() === "id") return null;

        return {
          id: idNormal,
          arcana: get("arcana"),
          suit: get("suit"),
          number: get("number"),
          name_ja: get("name_ja"),
          name_en: get("name_en"),
          element: get("element"),
          polarity: get("polarity"),
          yes_no_upright: get("yes_no_upright"),
          yes_no_reversed: get("yes_no_reversed"),
          timing: get("timing"),
          themes: get("themes"),
          keywords_upright: get("keywords_upright"),
          keywords_reversed: get("keywords_reversed"),
          core_upright: get("core_upright"),
          interpretation_upright: get("interpretation_upright"),
          angel_upright: get("angel_upright"),
          action_upright: get("action_upright"),
          core_reversed: get("core_reversed"),
          interpretation_reversed: get("interpretation_reversed"),
          angel_reversed: get("angel_reversed"),
          action_reversed: get("action_reversed"),
          image: normalizeImagePath(get("image")),
        };
      }

      // Columnå½¢å¼ã¯ä½¿ã‚ãªã„
      return null;
    } // â† ã“ã‚ŒãŒå¿…è¦


    function validateCards(list) {
      // id ã•ãˆã‚ã‚Œã°OKï¼ˆimageã¯ç„¡ãã¦ã‚‚å‹•ãï¼‰
      const bad = list.find(r => !r.id);
      return !bad;
    }



    function onPickFile() {
      const file = elFile.files?.[0];
      if (!file) return;

      setStatus("CSVã‚’èª­ã¿è¾¼ã¿ä¸­...");

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result?.toString() || "";
          const delim = guessDelimiterFromText(text);
          console.log("file guessed delimiter =", JSON.stringify(delim));

          const results = Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            delimiter: delim
          });



          // ===== Column1ã€œ è¡Œã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ =====
          if (results.meta?.fields?.[0]?.toLowerCase() === "column1") {
            console.log("Dummy header detected. Re-parsing CSV...");
            results.data.shift();
          }
          // ========================================




          const rows = (results.data || [])
            .map(normalizeRow)
            .filter(r => r && r.id);


          if (!rows.length) {
            setStatus("CSVã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆåŒºåˆ‡ã‚Š/ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèªï¼‰ã€‚");
            return;
          }
          if (!validateCards(rows)) {
            setStatus("å¿…é ˆåˆ—ï¼ˆid,name_ja,name_en,imageï¼‰ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
            return;
          }

          cards = rows;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
          setDeckInfo();
          setStatus(`èª­ã¿è¾¼ã¿å®Œäº†ï¼š${cards.length}æšã€‚å¼•ã‘ã¾ã™ã€‚`);
          showReady();
        } catch (e) {
          console.error(e);
          setStatus("èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ã€‚CSVå½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
      };
      reader.onerror = () => {
        setStatus("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      };
      reader.readAsText(file, "utf-8");
    }

    function useSaved() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) {
        setStatus("ä¿å­˜æ¸ˆã¿CSVãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšCSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      try {
        const rows = JSON.parse(saved);
        if (!Array.isArray(rows) || !rows.length) {
          setStatus("ä¿å­˜æ¸ˆã¿CSVãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚ã„ã£ãŸã‚“æ¶ˆã—ã¦èª­ã¿è¾¼ã¿ç›´ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        cards = rows;
        setDeckInfo();
        setStatus(`ä¿å­˜æ¸ˆã¿CSVã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼š${cards.length}æšã€‚`);
        showReady();
      } catch (e) {
        setStatus("ä¿å­˜æ¸ˆã¿CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚æ¶ˆã—ã¦èª­ã¿è¾¼ã¿ç›´ã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function clearSaved() {
      localStorage.removeItem(STORAGE_KEY);
      cards = [];
      setDeckInfo();
      setStatus("ä¿å­˜ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
      elResult.innerHTML = `<div class="empty">
    ã“ã“ã«çµæœãŒå‡ºã¾ã™ã€‚<br>
    â‘  CSVã‚’èª­ã¿è¾¼ã‚€ â†’ â‘¡ 1æš/3æšã‚’é¸ã¶ â†’ â‘¢ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€
  </div>`;
    }


    function showReady() {
      elResult.innerHTML = `<div class="empty">
        æº–å‚™OKã€‚<br>
        â‘¡ 1æš/3æšã‚’é¸ã¶ â†’ â‘¢ã€Œã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã€
      </div>`;
    }

    function startShuffle() { elShuffleArea.classList.add("shuffling"); }
    function stopShuffle() { elShuffleArea.classList.remove("shuffling"); }
    function randInt(n) { return Math.floor(Math.random() * n); }

    function drawUnique(count) {
      const used = new Set();
      const picked = [];
      while (picked.length < count) {
        const idx = randInt(cards.length);
        if (used.has(idx)) continue;
        used.add(idx);
        const card = cards[idx];
        const isReversed = Math.random() < 0.5;
        picked.push({ card, isReversed });
      }
      return picked;
    }


    async function onDraw() {
      if (!cards.length) {
        setStatus("å…ˆã«CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
        return;
      }
      const drawMode = document.querySelector('input[name="drawMode"]:checked')?.value || "1";
      const count = (String(drawMode) === "3") ? 3 : 1;

      setStatus(`ã‚·ãƒ£ãƒƒãƒ•ãƒ«ä¸­â€¦ï¼ˆ${count}æšå¼•ãï¼‰`);
      startShuffle();
      await new Promise(r => setTimeout(r, 1400));
      stopShuffle();

      const picked = drawUnique(count);
      console.log("picked[0] raw =", picked[0]);
      console.log("picked[0] json =", JSON.stringify(picked[0], null, 2));
      console.log("picked[0].card json =", JSON.stringify(picked[0]?.card, null, 2));




      const labels3 = ["éå»", "ç¾åœ¨", "æœªæ¥"];
      const gridClass = count === 1 ? "cardsGrid single" : "cardsGrid three";

      // --- Global Summary & Energy Block (Spread-level) ---
      let globalSummaryHTML = "";
      if (picked.length > 0) {
        const primaryCard = picked[0].card;
        const isReversed = picked[0].isReversed;
        const themes = (primaryCard.themes ?? "").toString().trim();
        const action = (isReversed ? primaryCard.action_reversed : primaryCard.action_upright) || "";

        const themeList = themes ? themes.split("|").flatMap(x => x.split(",")).map(t => t.trim()).filter(Boolean) : [];
        let mainTheme = themeList.length > 0 ? themeList[0] : (primaryCard.name_ja || "æœªçŸ¥");

        const mood = isReversed ? "é™ã‹ã«" : "ç¢ºã‹ã«";
        const actionSub = action ? action.substring(0, 20) + "â€¦" : "ä»Šã§ãã‚‹ã“ã¨ã‚’";

        let reasonText = "";
        let energyText = "";

        const cardId = normalizeKey(primaryCard.id) || normalizeKey(primaryCard.name_ja);
        const ymdKey = new Date().toISOString().slice(0, 10);
        const seedStr = `${ymdKey}|${cardId}|${isReversed ? "R" : "U"}`;

        // ======= DEEP READING DATA ========
        const cardDB = {
          "0": {
            light: "ç„¡é™ã®å¯èƒ½æ€§ã¨ç´”ç²‹ãªå¥½å¥‡å¿ƒã€‚",
            meaning: "ã„ã¾ã®ã‚ãªãŸã«ã¯ã€å¸¸è­˜ã‚„éå»ã®å¤±æ•—ã«ã¨ã‚‰ã‚ã‚Œãªã„èº«è»½ã•ãŒã‚ã‚Šã¾ã™ã€‚\nãµã¨æµ®ã‹ã‚“ã ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„è¡å‹•ã‚’ã€ã©ã†ã‹æ‰“ã¡æ¶ˆã•ãªã„ã§ãã ã•ã„ã€‚",
            actions: ["ã„ã¤ã‚‚ã¨é•ã†é“ã‚’æ­©ã„ã¦ã¿ã‚‹", "ç†ç”±ã®ãªã„ã€Œã‚„ã‚ŠãŸã„ã€ã‚’ä¸€ã¤å¶ãˆã‚‹"],
            prayer: "è‡ªç”±ãªé¢¨ãŒã€ã‚ãªãŸã®èƒŒä¸­ã‚’æŠ¼ã—ã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "1": {
            light: "ã™ã¹ã¦ã‚’å‰µã‚Šå‡ºã™ã€æ„æ€ã®åŠ›ã€‚",
            meaning: "ã™ã§ã«å¿…è¦ãªé“å…·ã‚„æ‰èƒ½ã¯ã€ã‚ãªãŸã®ä¸­ã«æƒã£ã¦ã„ã¾ã™ã€‚\nã‚ã¨ã¯ã€Œå§‹ã‚ã‚‹ã€ã¨æ±ºã‚ã‚‹ã ã‘ã€‚ã©ã‚“ãªå°ã•ãªä¸€æ­©ã§ã‚‚ã€ãã‚Œã¯å¤§ããªé­”æ³•ã®å§‹ã¾ã‚Šã§ã™ã€‚",
            actions: ["é ­ã®ä¸­ã«ã‚ã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ä¸€ã¤æ›¸ãå‡ºã™", "ã€Œè©¦ã—ã«ã€ã§ä½•ã‹ã‚’å§‹ã‚ã¦ã¿ã‚‹"],
            prayer: "ã‚ãªãŸã®æ„æ€ãŒã€æ–°ã—ã„ä¸–ç•Œã‚’å½¢ä½œã‚Šã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "2": {
            light: "é™å¯‚ã®ä¸­ã§ç£¨ã‹ã‚Œã‚‹ç›´æ„Ÿã€‚",
            meaning: "ä»Šã¯å¤–å´ã®æ„è¦‹ã‚ˆã‚Šã‚‚ã€å†…ãªã‚‹å£°ã«è€³ã‚’å‚¾ã‘ã‚‹æ™‚ã§ã™ã€‚\nç­”ãˆã‚’æ€¥ãŒãšã€ç™½é»’ã¤ã‘ãªã„ã€Œæ›–æ˜§ãªæ™‚é–“ã€ã‚’è¨±ã™ã“ã¨ã§ã€çœŸã®ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚",
            actions: ["1æ—¥5åˆ†ã€å®Œå…¨ã«é™ã‹ãªæ™‚é–“ã‚’ä½œã‚‹", "ç›´æ„Ÿçš„ã«æƒ¹ã‹ã‚ŒãŸã‚‚ã®ã‚’é¸ã¶"],
            prayer: "é™ã‹ãªç³ãŒã€çœŸå®Ÿã‚’è¦‹æŠœãã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "3": {
            light: "è±Šã‹ã•ã¨ã€ç„¡æ¡ä»¶ã®æ„›ã€‚",
            meaning: "ã‚ãªãŸã®äººç”Ÿã«ã€è±Šã‹ãªå®Ÿã‚Šã‚„æ„›ãŒæµã‚Œè¾¼ã‚‚ã†ã¨ã—ã¦ã„ã¾ã™ã€‚\nã¾ãšã¯è‡ªåˆ†è‡ªèº«ã‚’æ…ˆã—ã¿ã€å¿ƒåœ°ã‚ˆã„ã¨æ„Ÿã˜ã‚‹æ™‚é–“ã‚„å ´æ‰€ã‚’ãŸã£ã·ã‚Šã¨å‘³ã‚ã£ã¦ãã ã•ã„ã€‚",
            actions: ["äº”æ„ŸãŒå–œã¶ã“ã¨ï¼ˆç¾å‘³ã—ã„ã‚‚ã®ã€è‰¯ã„é¦™ã‚Šï¼‰ã‚’ã™ã‚‹", "è‡ªåˆ†ã‚’è¤’ã‚ã‚‹è¨€è‘‰ã‚’ä¸€æ—¥ä¸€ã¤è¦‹ã¤ã‘ã‚‹"],
            prayer: "è±Šã‹ãªå®Ÿã‚ŠãŒã€ã‚ãªãŸã®å¿ƒã‚’æº€ãŸã—ã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "4": {
            light: "æºã‚‹ããªã„åŸºç›¤ã¨ã€å®ˆã‚‹åŠ›ã€‚",
            meaning: "ä»Šã¯æƒ…ç†±ã ã‘ã§ãªãã€ç¾å®Ÿçš„ãªãƒ«ãƒ¼ãƒ«ã‚„ç§©åºã‚’é‡ã‚“ã˜ã‚‹ã“ã¨ã§ç‰©äº‹ãŒå®‰å®šã—ã¾ã™ã€‚\nç„¦ã‚‰ãšã€è¶³å…ƒã‚’å›ºã‚ã€é•·æœŸçš„ãªè¦–ç‚¹ã§è¨ˆç”»ã‚’ç«‹ã¦ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
            actions: ["éƒ¨å±‹ã‚„æœºã®ä¸Šã‚’æ•´ç†æ•´é “ã™ã‚‹", "æœªæ¥ã®ç›®æ¨™ã«å‘ã‘ãŸå°ã•ãªãƒ«ãƒ¼ãƒ«ã‚’ä½œã‚‹"],
            prayer: "ç¢ºã‹ãªè¶³å–ã‚ŠãŒã€ã‚ãªãŸã‚’æœ›ã‚€å ´æ‰€ã¸å°ãã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "5": {
            light: "ç²¾ç¥çš„ãªæ•™ãˆã¨ã€å°ãã€‚",
            meaning: "ä¸€æ™‚çš„ãªæ„Ÿæƒ…ã‚„åˆ©ç›Šã§ã¯ãªãã€ã‚ãªãŸã®ã€Œæœ¬è³ªçš„ãªä¾¡å€¤è¦³ã€ã«å¾“ã†æ™‚ã§ã™ã€‚\nå°Šæ•¬ã§ãã‚‹äººã®è¨€è‘‰ã‚’ãƒ’ãƒ³ãƒˆã«ã—ãŸã‚Šã€å¤ã„æ™ºæµã®ä¸­ã«ã‚ã‚‹æ™®éçš„ãªç­”ãˆã‚’æ¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚",
            actions: ["å¿ƒæƒ¹ã‹ã‚Œã‚‹æœ¬ã‹ã‚‰ä¸€è¡Œã®è¨€è‘‰ã‚’æ¢ã™", "è¿·ã£ãŸæ™‚ã¯ã€Œè‡ªåˆ†ã®ç¾å­¦ã«åã—ãªã„ã‹ã€ã§æ±ºã‚ã‚‹"],
            prayer: "è¦‹ãˆãªã„å°ããŒã€ã‚ãªãŸã®é“ã‚’ç…§ã‚‰ã—ã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "6": {
            light: "ç´”ç²‹ãªé¸æŠã¨ã€å¿ƒã®èª¿å’Œã€‚",
            meaning: "æå¾—ã§ã¯ãªãã€Œå¿ƒãŒæƒ¹ã‹ã‚Œã‚‹ã‹ã©ã†ã‹ã€ã§é¸ã¶æ™‚ã§ã™ã€‚\nç›´æ„Ÿçš„ã«æƒ¹ã‹ã‚Œåˆã†äººã‚„ç‰©äº‹ã¨ã®å‡ºä¼šã„ãŒã€ã‚ãªãŸã«ç¾ã—ã„èª¿å’Œã‚’ã‚‚ãŸã‚‰ã—ã¦ãã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚",
            actions: ["æœ¬å½“ã«ç€ãŸã„æœã‚„ä½¿ã„ãŸã„ã‚‚ã®ã‚’é¸ã¶", "èª°ã‹ã«å°ã•ãªæ„Ÿè¬ã‚’ä¼ãˆã‚‹"],
            prayer: "å¿ƒã®éŸ¿ãåˆã†é¸æŠãŒã€ã‚ãªãŸã‚’å¹¸ã›ã¸å°ãã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "7": {
            light: "å‰é€²ã™ã‚‹åŠ›ã¨ã€å‹åˆ©ã®äºˆæ„Ÿã€‚",
            meaning: "è¿·ã„ã‚„è‘›è—¤ã‚’ä¹—ã‚Šè¶Šãˆã€è‡ªåˆ†ã®æ‰‹ã§æ‰‹ç¶±ã‚’æ¡ã‚‹æ™‚ã§ã™ã€‚\nå¤šå°‘ã®å›°é›£ãŒã‚ã£ã¦ã‚‚ã€ä»Šã®ã‚ãªãŸã«ã¯ãã‚Œã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã¦é€²ã‚€ã ã‘ã®å‹¢ã„ã¨å¼·ã•ãŒã‚ã‚Šã¾ã™ã€‚",
            actions: ["ä»Šæ—¥ã‚„ã‚Šé‚ã’ã‚‹å°ã•ãªç›®æ¨™ã‚’ä¸€ã¤å®£è¨€ã™ã‚‹", "èƒŒç­‹ã‚’ä¼¸ã°ã—ã€å°‘ã—æ—©è¶³ã§æ­©ã„ã¦ã¿ã‚‹"],
            prayer: "åŠ›å¼·ã„å‰é€²ãŒã€ã‚ãªãŸã‚’å‹åˆ©ã¸ã¨å°ãã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "8": {
            light: "å„ªã—ã•ã¨ã€é™ã‹ãªå¿è€ã€‚",
            meaning: "åŠ›ã§æŠ¼ã•ãˆã¤ã‘ã‚‹ã®ã§ã¯ãªãã€å—ã‘å…¥ã‚ŒãªãŒã‚‰ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹å‹‡æ°—ãŒå¿…è¦ã§ã™ã€‚\nã‚ãªãŸã®ä¸­ã«ã‚ã‚‹ã€Œè¨±ã—ã€ã‚„ã€Œã—ãªã‚„ã‹ã•ã€ã“ããŒã€ä»Šã®çŠ¶æ³ã‚’ä¹—ã‚Šè¶Šãˆã‚‹æœ€å¼·ã®åŠ›ã¨ãªã‚Šã¾ã™ã€‚",
            actions: ["ã‚¤ãƒ©ãƒƒã¨ã—ãŸã‚‰ã€3å›æ·±å‘¼å¸ã—ã¦å¾…ã¤", "è‡ªåˆ†ã®ä¸­ã®å¼±ã•ã‚’ä¸€ã¤èªã‚ã¦ã‚ã’ã‚‹"],
            prayer: "ã—ãªã‚„ã‹ãªå¼·ã•ãŒã€ã‚ãªãŸã‚’å®ˆã‚Šã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "9": {
            light: "å†…çœã¨ã€é­‚ã®æ¢æ±‚ã€‚",
            meaning: "ã²ã¨ã¤ã®ã‚µã‚¤ã‚¯ãƒ«ãŒçµ‚ã‚ã‚Šã¸ã¨å‘ã‹ã„ã€é™ã‹ã«è‡ªåˆ†ã¨å‘ãåˆã†æ™‚æœŸã§ã™ã€‚\nå¤–ã®ä¸–ç•Œã®å–§é¨’ã‹ã‚‰å°‘ã—é›¢ã‚Œã€ã‚ãªãŸãŒæœ¬å½“ã«æ­©ã¿ãŸã„é“ã‚’è¦‹ç›´ã™ãŸã‚ã®æ™‚é–“ã‚’å–ã‚Šã¾ã—ã‚‡ã†ã€‚",
            actions: ["å¤œã€å°‘ã—ã ã‘ã‚¹ãƒãƒ›ã‚’è¦‹ãªã„æ™‚é–“ã‚’ä½œã‚‹", "æ—¥è¨˜ã‚’ã¤ã‘ã¦ã€ä»Šã®æ°—æŒã¡ã‚’è¨€èªåŒ–ã™ã‚‹"],
            prayer: "ã‚ãªãŸã®ç¯ã™å…‰ãŒã€çœŸå®Ÿã®é“ã‚’ç…§ã‚‰ã—ã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "10": {
            light: "é‹å‘½ã®è»¢æ›ã¨ã€æŠ—ãˆãªã„æµã‚Œã€‚",
            meaning: "ã‚ãªãŸã‚’å–ã‚Šå·»ãçŠ¶æ³ãŒã€æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ã¨å‹•ãå‡ºã—ã¦ã„ã¾ã™ã€‚\næ€ã„é€šã‚Šã«ãªã‚‰ãªã„ã“ã¨ãŒã‚ã£ã¦ã‚‚ã€ãã‚Œã¯å¤§ããªæµã‚Œã®ä¸€éƒ¨ã€‚å¤‰åŒ–ã‚’æã‚Œãšã€æµã‚Œã«ä¹—ã‚‹å‹‡æ°—ã‚’æŒã£ã¦ãã ã•ã„ã€‚",
            actions: ["æ™®æ®µé¸ã°ãªã„é¸æŠè‚¢ã‚’ã‚ãˆã¦é¸ã‚“ã§ã¿ã‚‹", "ã€Œãªã‚‹ã‚ˆã†ã«ãªã‚‹ã€ã¨å®‡å®™ã«å§”ã­ã¦ã¿ã‚‹"],
            prayer: "é‹å‘½ã®è¼ªãŒã€ã‚ãªãŸã‚’æœ€å–„ã®å ´æ‰€ã¸é‹ã³ã¾ã™ã‚ˆã†ã«ã€‚"
          },
          "default": {
            light: "ã‚«ãƒ¼ãƒ‰ãŒå°ãã€å°ã•ãªæ°—ã¥ãã€‚",
            meaning: "ã“ã®ã‚«ãƒ¼ãƒ‰ã¯ã€ä»Šã®ã‚ãªãŸã«å¿…è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã„ã¾ã™ã€‚\nç›´æ„Ÿçš„ã«æ„Ÿã˜ãŸã€Œç¬¬ä¸€å°è±¡ã€ã‚„ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ä¸­ã§ä¸€ç•ªå¿ƒã«éŸ¿ã„ãŸè¨€è‘‰ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚",
            actions: ["ãµã¨æ°—ã«ãªã£ãŸè¨€è‘‰ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠã", "ã¾ãšã¯ã‚†ã£ãã‚Šã¨æ·±å‘¼å¸ã‚’ä¸€ã¤"],
            prayer: "ã“ã®å‡ºä¼šã„ãŒã€ã‚ãªãŸã®å¿ƒã‚’è»½ãã—ã¾ã™ã‚ˆã†ã«ã€‚"
          }
        };

        const dbEntry = cardDB[cardId] || cardDB[primaryCard.number] || cardDB["default"];

        /* =========================================
           ğŸ’— Love Action Integrated Reason Builder
           - One paste complete version
           ========================================= */

        /* --- Love action dictionaries --- */

        const loveActionsUpright = [
          "çŸ­ã„ä¸€è¨€ã ã‘ã§ã‚‚ã€è‡ªåˆ†ã‹ã‚‰é€£çµ¡ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "è¿”ä¿¡ã‚’è¿·ã‚ãšã€ç´ ç›´ãªè¨€è‘‰ã§è¿”ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’1å›å¤šãä¼ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "ã²ã¨ã¤ã ã‘æœ¬éŸ³ã‚’æ··ãœã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "æ›–æ˜§ãªã¾ã¾ã®ã“ã¨ã‚’ä¸€ã¤ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "æ¬¡ã«ä¼šã†ç´„æŸã®è©±é¡Œã‚’å‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "æœŸå¾…ã‚’å„ªå…ˆã—ã¦é¸æŠã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "ç¬‘é¡”ã®æ™‚é–“ã‚’æ„è­˜ã—ã¦å¢—ã‚„ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "ç›®ã‚’è¦‹ã¦è©±ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "å‹‡æ°—ã‚’å‡ºã—ã¦ä¸€ã¤è³ªå•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚"
        ];

        const loveActionsReversed = [
          "è¿”ä¿¡ã‚’æ€¥ãŒãšã€è‡ªåˆ†ã®æ°—æŒã¡ã‚’æ•´ãˆã¾ã—ã‚‡ã†ã€‚",
          "ç›¸æ‰‹ã®è¨€è‘‰ã‚’æ·±èª­ã¿ã—ã™ããªã„ã¨æ±ºã‚ã¾ã—ã‚‡ã†ã€‚",
          "SNSã‚’15åˆ†ã ã‘è¦‹ãªã„æ™‚é–“ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚",
          "å«Œã ã£ãŸã“ã¨ã‚’ç´™ã«æ›¸ãå‡ºã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
          "è‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã‚’å®ˆã‚‹é¸æŠã‚’ã—ã¾ã—ã‚‡ã†ã€‚",
          "ç„¡ç†ã«å„ªã—ãã—ãªã„ã¨æ±ºã‚ã¾ã—ã‚‡ã†ã€‚",
          "æ—¢èª­ã‚¹ãƒ«ãƒ¼ã‚’æã‚Œãªã„ç·´ç¿’ã‚’ã—ã¾ã—ã‚‡ã†ã€‚",
          "ä»Šæ—¥ã¯æ—©ã‚ã«å¯ã¦å¿ƒã‚’å›å¾©ã•ã›ã¾ã—ã‚‡ã†ã€‚",
          "ä»Šã¯å¾…ã¤ã¨è‡ªåˆ†ã«è¨±å¯ã‚’å‡ºã—ã¾ã—ã‚‡ã†ã€‚",
          "ç›¸æ‰‹ã‚ˆã‚Šè‡ªåˆ†ã®æ©Ÿå«Œã‚’å„ªå…ˆã—ã¾ã—ã‚‡ã†ã€‚"
        ];

        /* =========================================
           ğŸ’¼ Work Action Builder (Stable + Short)
           - Deterministic pick per card/date
           ========================================= */

        /* Work action dictionaries */
        const workActionsUpright = [
          "ä»Šæ—¥ã®æœ€å„ªå…ˆã‚’1ã¤æ±ºã‚ã‚‹ã€‚",
          "15åˆ†ã ã‘ã‚¿ã‚¹ã‚¯ã‚’å‰ã«é€²ã‚ã‚‹ã€‚",
          "å…ˆã«çµè«–ã‚’1è¡Œã§æ›¸ãã€‚",
          "è¿·ã£ã¦ã„ã‚‹æ¡ˆä»¶ã‚’A/Bã§æ±ºã‚ã‚‹ã€‚",
          "æœ€åˆã®ä¸€æ‰‹ã ã‘ç€æ‰‹ã™ã‚‹ã€‚",
          "è¿”ä¿¡ãŒå¿…è¦ãªã‚‚ã®ã‚’1ä»¶ç‰‡ä»˜ã‘ã‚‹ã€‚",
          "æœŸé™ã¨æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ˜æ–‡åŒ–ã™ã‚‹ã€‚",
          "ç›¸æ‰‹ã®æœŸå¾…å€¤ã‚’ç¢ºèªã™ã‚‹ã€‚",
          "è³‡æ–™ã®å†’é ­ã ã‘æ•´ãˆã‚‹ã€‚",
          "è‡ªåˆ†ã®å¼·ã¿ã‚’1ã¤ä½¿ã†ã€‚"
        ];

        const workActionsReversed = [
          "ç„¡ç†ãªäºˆå®šã‚’1ã¤æ¸›ã‚‰ã™ã€‚",
          "æ›–æ˜§ãªä¾é ¼ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å‹•ãã€‚",
          "ä»Šæ—¥ã¯çµè«–ã‚’æ€¥ãŒãªã„ã€‚",
          "ã‚„ã‚‰ãªã„ã“ã¨ã‚’1ã¤æ±ºã‚ã‚‹ã€‚",
          "ä½œæ¥­ç’°å¢ƒã‚’10åˆ†æ•´ãˆã‚‹ã€‚",
          "è©°ã‚è¾¼ã¿ã‚’ã‚„ã‚ã¦ä½™ç™½ã‚’ä½œã‚‹ã€‚",
          "å…ˆå»¶ã°ã—ã®åŸå› ã‚’1è¡Œã§æ›¸ãã€‚",
          "ç›¸è«‡ã™ã‚‹ç›¸æ‰‹ã‚’1äººæ±ºã‚ã‚‹ã€‚",
          "ä¼‘æ†©ã‚’å…ˆã«ç¢ºä¿ã™ã‚‹ã€‚",
          "å¢ƒç•Œç·šã‚’å¼•ãï¼ˆæ–­ã‚‹/å¾Œå›ã—ï¼‰ã€‚"
        ];

        /* =========================================
           ğŸ’° Money Action Builder (Stable + Short)
           - Deterministic pick per card/date
           ========================================= */

        const moneyActionsUpright = [
          "å°ã•ãªè‡¨æ™‚åå…¥ã®èŠ½ã‚’1ã¤æ¢ã™ã€‚",
          "æ”¯å‡ºã‚’1ä»¶ã ã‘æœ€é©åŒ–ã™ã‚‹ã€‚",
          "å›ºå®šè²»ã®æ˜ç´°ã‚’1ã¤ç¢ºèªã™ã‚‹ã€‚",
          "è²·ã„ç‰©ã¯â€œå¿…è¦â€ã ã‘ã«çµã‚‹ã€‚",
          "æœªæ¥ã®ãŸã‚ã«å°‘é¡ã‚’ç©ã¿ç«‹ã¦ã‚‹ã€‚",
          "å¾—ã™ã‚‹é¸æŠã‚’1ã¤ã ã‘ã™ã‚‹ã€‚",
          "ä¸è¦ãªã‚µãƒ–ã‚¹ã‚¯ã‚’1ã¤è¦‹ç›´ã™ã€‚",
          "ãŠé‡‘ãŒå…¥ã‚‹å°ç·šã‚’1ã¤æ•´ãˆã‚‹ã€‚",
          "ä¾¡å€¤ã®ã‚ã‚‹å­¦ã³ã«15åˆ†ä½¿ã†ã€‚",
          "è²¡å¸ƒï¼ˆã¾ãŸã¯å£åº§ï¼‰ã‚’æ•´ãˆã‚‹ã€‚"
        ];

        const moneyActionsReversed = [
          "è¡å‹•è²·ã„ã‚’ä»Šæ—¥ã¯ã—ãªã„ã¨æ±ºã‚ã‚‹ã€‚",
          "è¦‹æ „ã®å‡ºè²»ã‚’1ã¤æ‰‹æ”¾ã™ã€‚",
          "æ”¯å‡ºã®åŸå› ã‚’1è¡Œã§æ›¸ãã€‚",
          "é«˜ã„è²·ã„ç‰©ã¯24æ™‚é–“å¾…ã¤ã€‚",
          "äºˆç®—ã®ä¸Šé™ã‚’å…ˆã«æ±ºã‚ã‚‹ã€‚",
          "ä»Šæœˆã®â€œä½¿ã„ã™ãé …ç›®â€ã‚’1ã¤ç‰¹å®šã™ã‚‹ã€‚",
          "ãƒ¬ã‚·ãƒ¼ãƒˆã‚’3æšã ã‘æ•´ç†ã™ã‚‹ã€‚",
          "æå¤±ã‚’åºƒã’ãªã„é¸æŠã‚’ã™ã‚‹ã€‚",
          "ç„¡ç†ãªæŠ•è³‡ã‚„è³­ã‘ã‚’é¿ã‘ã‚‹ã€‚",
          "ã¾ãšç”Ÿæ´»ã®å®‰å¿ƒã‚’å„ªå…ˆã™ã‚‹ã€‚"
        ];

        /* --- Utility --- */

        function stableIndex(seedStr, mod) {
          // simple deterministic hash
          let h = 2166136261;
          for (let i = 0; i < seedStr.length; i++) {
            h ^= seedStr.charCodeAt(i);
            h = Math.imul(h, 16777619);
          }
          return Math.abs(h) % mod;
        }

        function pickStable(arr, seedStr) {
          return arr[stableIndex(seedStr, arr.length)];
        }

        function toShortAction(action) {
          // optional: shorten overly long endings
          return action
            .replace("ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚", "ã™ã‚‹ã€‚")
            .replace("ã—ã¾ã—ã‚‡ã†ã€‚", "ã™ã‚‹ã€‚")
            .replace("æ±ºã‚ã¾ã—ã‚‡ã†ã€‚", "æ±ºã‚ã‚‹ã€‚");
        }

        function normalizeThemes(themes) {
          let s = "";
          if (Array.isArray(themes)) s = themes.join(" ");
          else if (typeof themes === "string") s = themes;
          else s = "";
          s = s.trim();
          try { s = s.normalize("NFKC"); } catch (_) { }
          return s;
        }

        function isMoneyTheme(themes, cardName) {
          const t = normalizeThemes(themes);
          const n = (cardName || "");
          const hay = `${t} ${n}`;
          const kws = [
            "é‡‘", "è²¡", "å¯Œ", "è±Š", "éŠ­", "ç¨¼", "å", "å…¥", "çµ¦", "å ±", "åˆ©", "ç›Š", "å£²", "å•†",
            "è²¯", "è²¯é‡‘", "ç¯€", "ç¯€ç´„", "æŠ•", "æŠ•è³‡", "è³‡", "è³‡ç”£", "é‹ç”¨", "è²¡å¸ƒ", "å£åº§",
            "ãƒšãƒ³ã‚¿", "ãƒšãƒ³ã‚¿ã‚¯ãƒ«", "ã‚³ã‚¤ãƒ³", "pentacle", "coin", "money", "wealth"
          ];
          return kws.some(k => hay.includes(k));
        }

        /* =========================================
           ğŸ§© Readability helpers
           - remove jargon like "LP"
           - format reason text into readable blocks
           ========================================= */

        function formatNumerologyLabel(nStr) {
          // nStr: "1" ãªã©
          const n = (nStr || "").toString().trim();
          if (!n) return "";
          // "LP" ãªã©ç•¥èªã¯å‡ºã•ãšã«ã€åˆå¿ƒè€…å‘ã‘ãƒ©ãƒ™ãƒ«ã§è¡¨ç¤º
          return `ã‚ãªãŸã®æœ¬è³ªï¼ˆæ•°ç§˜${n}ï¼‰`;
        }

        function formatKyuseiLabel(kStr) {
          const k = (kStr || "").toString().trim();
          if (!k) return "";
          // ä¹æ˜Ÿã¯æŠ¼ã—ã¤ã‘ãšã€ã‚„ã•ã—ã„æ–‡ï¼‹æ‹¬å¼§
          return `æ°—è³ªã®å‚¾å‘ï¼ˆ${k}ï¼‰`;
        }

        /**
         * reasonText ã‚’ã€Œçµè«– / ç†ç”± / ä»Šæ—¥ã¯ã€ã«æ•´å½¢ã™ã‚‹
         * - basePoetic: è©©çš„ãªçµè«–1ã€œ2æ–‡
         * - baseExplain: å…·ä½“åŒ–ï¼ˆã¤ã¾ã‚Šã€œï¼‰
         * - closing: ä»Šæ—¥ã¯ã€œ ã®è¡Œ
         * - optionalMetaLines: è¿½åŠ ã®è£œè¶³ï¼ˆæ•°ç§˜/ä¹æ˜Ÿãªã©ï¼‰â€»çŸ­ã
         */
        function buildReadableReason({ basePoetic, baseExplain, closing, optionalMetaLines = [] }) {
          const meta = (optionalMetaLines || []).filter(Boolean).join("\n");
          return [
            `ã€çµè«–ã€‘${(basePoetic || "").trim()}`,
            `ã€ç†ç”±ã€‘ã¤ã¾ã‚Šã€${(baseExplain || "").trim()}${meta ? "\n" + meta : ""}`,
            `ã€ä»Šæ—¥ã¯ã€‘${(closing || "").trim()}`
          ].join("\n");
        }

        /**
         * basePoetic: è©©çš„1æ–‡
         * baseExplain: å…·ä½“åŒ–ï¼ˆã¤ã¾ã‚Šï¼‰
         * isReversed: æ­£é€†
         * cardKey: ã‚«ãƒ¼ãƒ‰å or id (å¿…é ˆï¼šå®‰å®šé¸æŠã«ä½¿ã†)
         * ymdKey: ä»Šæ—¥ã®æ—¥ä»˜ "YYYY-MM-DD"ï¼ˆãªã‘ã‚Œã°ç”Ÿæˆï¼‰
         */
        function buildLoveReasonTextStable({ basePoetic, baseExplain, isReversed, cardKey, ymdKey }) {

          const today = ymdKey || new Date().toISOString().slice(0, 10);
          const seed = `${today}|${cardKey || "card"}|${isReversed ? "R" : "U"}`;

          const rawAction = isReversed
            ? pickStable(loveActionsReversed, seed)
            : pickStable(loveActionsUpright, seed);

          const action = toShortAction(rawAction);

          const closing = isReversed
            ? `ä»Šæ—¥ã¯${action} æ•´ãˆã‚‹ã»ã©ã€é™ã‹ã«å®ˆã‚‰ã‚Œã‚‹ã€‚`
            : `ä»Šæ—¥ã¯${action} å°ã•ãå‹•ãã»ã©ã€æµã‚ŒãŒå‘³æ–¹ã™ã‚‹ã€‚`;

          return buildReadableReason({
            basePoetic,
            baseExplain,
            closing,
            optionalMetaLines: [
              // æ‹æ„›ã§ã¯æ•°ç§˜/ä¹æ˜Ÿã¯å‡ºã—ã™ãã‚‹ã¨é‡ã„ã®ã§ã€Œå¿…è¦ãªã‚‰ã€ã ã‘
              // ã“ã“ã¯ç©ºã«ã—ã¦ã‚‚OKã€‚æ®‹ã™å ´åˆã‚‚çŸ­ãã€‚
            ]
          });
        }

        function buildMoneyReasonTextStable({ basePoetic, baseExplain, isReversed, cardKey, ymdKey }) {
          const today = ymdKey || new Date().toISOString().slice(0, 10);
          const seed = `${today}|${cardKey || "card"}|${isReversed ? "R" : "U"}|money`;

          const rawAction = isReversed
            ? pickStable(moneyActionsReversed, seed)
            : pickStable(moneyActionsUpright, seed);

          const action = toShortAction(rawAction);

          const closing = isReversed
            ? `ä»Šæ—¥ã¯${action} æ•´ãˆã‚‹ã»ã©ã€é™ã‹ã«å®ˆã‚‰ã‚Œã‚‹ã€‚`
            : `ä»Šæ—¥ã¯${action} å°ã•ãå‹•ãã»ã©ã€æµã‚ŒãŒå‘³æ–¹ã™ã‚‹ã€‚`;

          return buildReadableReason({
            basePoetic,
            baseExplain,
            closing,
            optionalMetaLines: [
              // é‡‘é‹ã¯ â€œãªãœé‡‘é‹?â€ ã‚’é˜²ããŸã‚ã«ä¸€è¡Œã ã‘æ·»ãˆã‚‹ï¼ˆæŠ¼ã—ã¤ã‘ãªã„ï¼‰
              "ã“ã®ã‚«ãƒ¼ãƒ‰ã¯â€œä¾¡å€¤ãƒ»å¾ªç’°ãƒ»ç‰©è³ªâ€ã«è§¦ã‚Œã¦ã„ã‚‹ãŸã‚ã€é‡‘é‹ã®åŠ©è¨€ã¨ã—ã¦èª­ã‚ã¾ã™ã€‚"
            ]
          });
        }

        /**
         * basePoetic: è©©çš„1æ–‡
         * baseExplain: å…·ä½“åŒ–ï¼ˆã¤ã¾ã‚Šï¼‰
         * isReversed: æ­£é€†
         * cardKey: ã‚«ãƒ¼ãƒ‰å or id
         * ymdKey: "YYYY-MM-DD"ï¼ˆçœç•¥å¯ï¼‰
         */
        function buildWorkReasonTextStable({ basePoetic, baseExplain, isReversed, cardKey, ymdKey }) {
          const today = ymdKey || new Date().toISOString().slice(0, 10);
          const seed = `${today}|${cardKey || "card"}|${isReversed ? "R" : "U"}|work`;

          const rawAction = isReversed
            ? pickStable(workActionsReversed, seed)
            : pickStable(workActionsUpright, seed);

          const action = toShortAction(rawAction);

          const closing = isReversed
            ? `ä»Šæ—¥ã¯${action} æ•´ãˆã‚‹ã»ã©ã€é™ã‹ã«å®ˆã‚‰ã‚Œã‚‹ã€‚`
            : `ä»Šæ—¥ã¯${action} å°ã•ãå‹•ãã»ã©ã€æµã‚ŒãŒå‘³æ–¹ã™ã‚‹ã€‚`;

          return buildReadableReason({
            basePoetic,
            baseExplain,
            closing,
            optionalMetaLines: []
          });
        }

        if (typeof calculateLifePath === "function" && typeof getHonmeiStar === "function") {
          const uDate = document.getElementById("userBirthdate")?.value;
          const pDate = document.getElementById("partnerBirthdate")?.value;

          if (uDate) {
            const lp = calculateLifePath(uDate);
            const [y, m, d] = uDate.split("-");
            const honmei = getHonmeiStar(y, m, d);

            const honmeiTheme = honmei && STAR_DATA[honmei] ? STAR_DATA[honmei].theme : "æµã‚Œã‚’æ•´ãˆã‚‹";
            const honmeiName = honmei && STAR_DATA[honmei] ? STAR_DATA[honmei].name : `æœ¬å‘½æ˜Ÿ${honmei}`;
            const lpDesc = NUMEROLOGY_DATA[lp] ? NUMEROLOGY_DATA[lp].lp : "è»¸ã‚’æ•´ãˆã‚‹";

            const basePoetic = `ã‚«ãƒ¼ãƒ‰ã«å®¿ã‚‹ã€${mainTheme}ã€ã®åŠ›ãŒã€ã‚ãªãŸã‚’å‘¼ã‚“ã§ã„ã‚‹ã‹ã‚‰ã€‚`;
            const baseExplain = `${formatNumerologyLabel(lp)}ã¯â€œ${lpDesc}â€ã€‚${formatKyuseiLabel(honmeiName)}ã¯â€œ${honmeiTheme}â€ã€‚`;

            // æ‹æ„›ï¼ˆç›¸æ‰‹ã®æ—¥ä»˜ã‚ã‚Šï¼‰ã‹ã€ãƒ†ãƒ¼ãƒã«ã‚ˆã‚‹ä»•äº‹/é‡‘é‹ã®æ¨æ¸¬

            if (pDate) {
              reasonText = buildLoveReasonTextStable({
                basePoetic,
                baseExplain,
                isReversed,
                cardKey: primaryCard.id || primaryCard.name_ja
              });
            } else if (!pDate && isMoneyTheme(primaryCard.themes, primaryCard.name_ja || primaryCard.name)) {
              reasonText = buildMoneyReasonTextStable({
                basePoetic,
                baseExplain,
                isReversed,
                cardKey: primaryCard.id || primaryCard.name_ja
              });
            } else {
              reasonText = buildWorkReasonTextStable({
                basePoetic,
                baseExplain,
                isReversed,
                cardKey: primaryCard.id || primaryCard.name_ja
              });
            }

            energyText += `\n\nã€ã‚ãªãŸã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‘\nãƒ»æ•°ç§˜ï¼šãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹${lp}ï¼ˆ${lpDesc}ï¼‰\nãƒ»ä¹æ˜Ÿï¼š${honmeiName}ï¼ˆ${honmeiTheme}ï¼‰`;
          } else {
            reasonText = `ã‚«ãƒ¼ãƒ‰ã«å®¿ã‚‹ã€${mainTheme}ã€ã®åŠ›ãŒã€ã‚ãªãŸã‚’å‘¼ã‚“ã§ã„ã‚‹ã‹ã‚‰ã€‚`;
          }

          if (pDate) {
            const p_lp = calculateLifePath(pDate);
            const [py, pm, pd] = pDate.split("-");
            const p_star = getHonmeiStar(py, pm, pd);

            const p_starTheme = p_star && STAR_DATA[p_star] ? STAR_DATA[p_star].theme : "æµã‚Œã‚’æ•´ãˆã‚‹";
            const p_starName = p_star && STAR_DATA[p_star] ? STAR_DATA[p_star].name : `æœ¬å‘½æ˜Ÿ${p_star}`;
            const p_lpDesc = NUMEROLOGY_DATA[p_lp] ? NUMEROLOGY_DATA[p_lp].lp : "è»¸ã‚’æ•´ãˆã‚‹";

            energyText += `\n\nã€ãŠç›¸æ‰‹ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‘\nãƒ»æ•°ç§˜ï¼šãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹${p_lp}ï¼ˆ${p_lpDesc}ï¼‰\nãƒ»ä¹æ˜Ÿï¼š${p_starName}ï¼ˆ${p_starTheme}ï¼‰`;
          }
        } else {
          reasonText = `ã‚«ãƒ¼ãƒ‰ã«å®¿ã‚‹ã€${mainTheme}ã€ã®åŠ›ãŒã€ã‚ãªãŸã‚’å‘¼ã‚“ã§ã„ã‚‹ã‹ã‚‰ã€‚`;
        }

        const SUPP_RE = /(æ•°ç§˜|ä¹æ˜Ÿ|å®¿æ›œ|å¹²æ”¯|æ˜Ÿåº§|ãƒ©ãƒƒã‚­ãƒ¼|é–‹é‹|æ–¹ä½|é¢¨æ°´|ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼|ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ |ã‚«ãƒ©ãƒ¼|ã‚¢ã‚¤ãƒ†ãƒ )/;

        const normalized = String(reasonText ?? "")
          .replace(/<br\s*\/?>/gi, "\n")
          .replace(/\r\n/g, "\n")
          .replace(/\r/g, "\n");

        const lines = normalized
          .split("\n")
          .map(l => l.replace(/<\/?[^>]+>/g, "").trim())
          .filter(l => l.length > 0);

        const suppLines = [];
        const mainLines = [];
        for (const line of lines) {
          if (SUPP_RE.test(line)) suppLines.push(line);
          else mainLines.push(line);
        }

        const limitedSupp = suppLines
          .map(s => s.trim())
          .filter(s => s.length > 0)
          .slice(0, 2);

        const cleanSupp = (limitedSupp || [])
          .map(s => String(s || "")
            .replace(/^ã€(çµè«–|ç†ç”±|ä»Šæ—¥ã¯|è£œè¶³)ã€‘/g, "")
            .replace(/^(ç†ç”±|ä»Šæ—¥ã¯|çµè«–)[ï¼‰\):ï¼š]\s*/g, "")
            .trim()
          )
          .filter(s => s.length > 0 && !/^[ãƒ»\-\s]+$/.test(s))
          .slice(0, 2);

        const suppInline = cleanSupp.join(" / ");

        const mainText = mainLines.join("\n");

        const summaryConclusion = `ã€çµè«–ã€‘${mood}ã€ã‚ãªãŸã®å¿ƒã¯ã€Œ${mainTheme}ã€ã¸ã¨å‘ã‹ã£ã¦ã„ã‚‹ã€‚`;
        const summaryReason = `ã€ç†ç”±ã€‘${mainText}`;
        const summaryAction = `ã€ä¸€æ­©ã€‘${actionSub} ã‚ãªãŸã¯ã‚‚ã†ååˆ†ã€ã‚„ã£ã¦ããŸã€‚`;

        let safeEnergy = "";
        if (energyText) {
          safeEnergy = `<div class="summaryText" style="margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px;">${escapeHtml(energyText).replace(/\n/g, "<br>")}</div>`;
        }

        let mainReasonHTML = escapeHtml(summaryReason).replace(/\n/g, "<br>");
        mainReasonHTML = mainReasonHTML.replace(
          /ã€ä»Šæ—¥ã¯ã€‘([^<]*)/g,
          'ã€ä»Šæ—¥ã¯ã€‘<span style="color:#fff; font-weight:600;">$1</span>'
        );
        if (suppInline) {
          mainReasonHTML += `<br><span style="opacity:.85;">ã€è£œè¶³ã€‘${escapeHtml(suppInline)}</span>`;
        }

        const readingHTML = `
          <div style="margin-top:20px; text-align:left;">
            <div style="font-weight:900; color:var(--accent); font-size:14px; margin-bottom:8px;">ã€å…‰ã®è¦ç´„ã€‘<br><span style="color:#fff;font-weight:600;">${dbEntry.light}</span></div>
            <div style="font-size:13px; color:rgba(255,255,255,.9); line-height:1.8; margin-bottom:12px;">ã€ã‚ãªãŸã¸ã®æ„å‘³ã€‘<br>${dbEntry.meaning.replace(/\n/g, '<br>')}</div>
            <div style="font-size:13px; color:rgba(255,255,255,.9); line-height:1.8; margin-bottom:12px;">ã€å°ã•ãªè¡Œå‹•ã€‘<br>ãƒ»${dbEntry.actions[0]}<br>ãƒ»${dbEntry.actions[1]}</div>
            <div style="font-size:13px; color:var(--accent2); font-style:italic;">ã€ç¥ˆã‚Šã€‘<br>${dbEntry.prayer}</div>
          </div>
        `;

        globalSummaryHTML = `
      <div class="summaryCard line">
        <div class="summaryTitle">${escapeHtml(summaryConclusion)}</div>
        <div class="summaryText">${mainReasonHTML}</div>
        <div class="summaryText" style="font-weight: bold; color: rgba(255,255,255,.95);">${escapeHtml(summaryAction)}</div>
        ${safeEnergy}
        ${readingHTML}
      </div>
    `;
      }



      let wrapUpHTML = "";
      if (count === 3) {
        wrapUpHTML = `
          <div class="summaryCard line" style="margin-top:16px;">
            <div style="font-size:14px; font-weight:800; color:var(--accent); margin-bottom:6px;">ã€3æšã®çµã³ã€‘</div>
            <div style="font-size:13px; line-height:1.7; color:rgba(255,255,255,.9);">
              éå»ã‹ã‚‰å°ã‹ã‚ŒãŸã‚ãªãŸã®è»Œè·¡ã¯ã€ç¾åœ¨ã®æ°—ã¥ãã‚’é€šã—ã¦ã€ç¢ºå®Ÿã«æ–°ã—ã„æœªæ¥ã¸ã¨ç¹‹ãŒã£ã¦ã„ã¾ã™ã€‚ç„¦ã‚‰ãšã€ä»Šã®è‡ªåˆ†ã‚’ä¿¡ã˜ã¦æ­©ã¿ã‚’é€²ã‚ã¦ãã ã•ã„ã€‚
            </div>
          </div>
        `;
      }

      const actionsHTML = `
        <div class="resultActions">
          <div class="shareTitle">Share This Reading</div>
          <div class="shareRow">
            <button class="btnGhost" onclick="shareResultText()">Share</button>
            <button class="btnGhost" onclick="copyResultText()">Copy</button>
            <button class="btnGhost" onclick="shareResultImage()">Share Image</button>
          </div>
          <button class="btnDrawAgain" onclick="onDraw()">ã‚‚ã†ä¸€åº¦ã²ã</button>
          <a class="numerologyLink" href="./numbers.html" target="_blank">æ•°å­—ã®æ„å‘³ã‚’è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã“ã¡ã‚‰</a>
        </div>
      `;

      elResult.innerHTML = `
  ${globalSummaryHTML}
  <div class="${gridClass}">
    ${picked.map((p, i) =>
        renderCard(p.card, p.isReversed, count === 3 ? labels3[i] : "")
      ).join("")}
  </div>
  ${wrapUpHTML}
  ${actionsHTML}
`;

      setStatus(`çµæœè¡¨ç¤ºï¼š${count}æšå¼•ãã€‚`);
      scrollToResultSmooth();

      elResult.classList.remove("result-animate");
      void elResult.offsetWidth; // reflow
      elResult.classList.add("result-animate");
      requestAnimationFrame(() => {
        elResult.classList.add("show");
      });
    }

    // --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š| åŒºåˆ‡ã‚Šã§æœ€å¤§10å€‹ ---
    function splitKeywords(str, limit = 10) {
      const raw = (str ?? "").toString().trim();
      if (!raw) return [];
      return raw.split("|").map(s => s.trim()).filter(Boolean).slice(0, limit);
    }
    function strengthenCore(core, themes) {
      const c = (core ?? "").toString().trim();

      // 55æ–‡å­—ä»¥ä¸Šãªã‚‰ã€ãã®ã¾ã¾è¿”ã™ï¼ˆå®Œå…¨ãƒãƒ¼ã‚¿ãƒƒãƒï¼‰
      if (c.length >= 55) return c;

      const t = (themes ?? "").toString().trim();
      const focus = t ? t.split("|")[0].trim() : "";

      // çŸ­ã„ã¨ãã ã‘åº•ä¸Šã’ï¼ˆæœ€ä½40æ–‡å­—ã‚’ç‹™ã†ï¼‰
      const base = c || "ã„ã¾ã¯æµã‚Œã®ç¯€ç›®ã«ã„ã¾ã™ã€‚";
      const focusLine = focus
        ? `ç„¦ç‚¹ï¼š${focus}ã€‚`
        : `ç„¦ç‚¹ï¼šã„ã¾å¤§åˆ‡ãªæ„Ÿè¦šã«æ°—ã¥ãã“ã¨ã€‚`;
      const direction = `æ–¹å‘æ€§ï¼šç„¦ã‚‰ãšã€ã§ãã‚‹ä¸€æ­©ã‚’é¸ã³ã¾ã—ã‚‡ã†ã€‚`;

      let out = `${base} ${focusLine} ${direction}`;

      // æœ€ä½40æ–‡å­—ã®ä¿é™ºï¼ˆçŸ­ã™ãã‚‹ã‚«ãƒ¼ãƒ‰ç”¨ï¼‰
      if (out.length < 40) {
        out += " å—ã‘å–ã£ãŸåˆå›³ã‚’å¤§åˆ‡ã«ã€‚";
      }

      return out;
    }



    function metaLine(card) {
      const parts = [];
      if (card.arcana) parts.push(`åŒºåˆ†:${card.arcana}`);
      if (card.suit) parts.push(`ã‚¹ãƒ¼ãƒˆ:${card.suit}`);
      if (card.number) parts.push(`ç•ªå·:${card.number}`);
      if (card.element) parts.push(`å…ƒç´ :${card.element}`);
      if (card.polarity) parts.push(`æ¥µæ€§:${card.polarity}`);
      if (card.timing) parts.push(`æ™‚æœŸ:${card.timing}`);
      return parts.join(" / ");
    }


    // --- 4ã¤ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼åˆ†é¡ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ ---
    function generateEnergyCategories(uDate, pDate) {
      if (!uDate) return "";

      const lp = calculateLifePath(uDate);
      const [y, m, d] = uDate.split("-");
      const honmei = getHonmeiStar(y, m, d) || 1;
      const isLpOdd = lp % 2 !== 0;
      const hElement = STAR_DATA[honmei] ? STAR_DATA[honmei].element : "æ°´";

      // è¦ä»¶ã«ã‚ã‚‹ calculateNameNumbers ã®åˆ©ç”¨ (Nameå…¥åŠ›ãŒãªã„ãŸã‚ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã§ç®—å‡º)
      const nameEnergy = typeof calculateNameNumbers === "function" ? calculateNameNumbers("TAROT") : { su: 3, pe: 5 };
      const hasStrongSoul = nameEnergy.su >= 5;

      let romance = "ã€æ‹æ„›ã€‘";
      if (pDate) {
        const p_lp = calculateLifePath(pDate);
        if (lp === p_lp || (isLpOdd && p_lp % 2 !== 0) || (!isLpOdd && p_lp % 2 === 0)) {
          romance += "æ³¢é•·ãŒåˆã„ã‚„ã™ã„æ™‚æœŸã€‚ãŠäº’ã„ã®é•·æ‰€ã‚’èªã‚åˆã†ã“ã¨ã§çµ†ãŒæ·±ã¾ã‚Šã¾ã™ã€‚";
        } else {
          romance += "é•ã†è¦–ç‚¹ã‚’æŒã¤ã‹ã‚‰ã“ãè£œã„åˆãˆã‚‹é–¢ä¿‚ã€‚é•ã„ã‚’æ¥½ã—ã‚€å¿ƒã®ã‚†ã¨ã‚ŠãŒæ„›ã‚’è‚²ã¦ã¾ã™ã€‚";
        }
      } else {
        romance += (hElement === "æ°´" || hElement === "æœ¨" || hasStrongSoul)
          ? "æŸ”ã‚‰ã‹ãªæ°—é…ã‚ŠãŒã”ç¸ã‚’å¼•ãå¯„ã›ã‚‹æ™‚ã€‚è‡ªç„¶ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‰ã€‚"
          : "ã‚ãªãŸã®æƒ…ç†±ã‚„èŠ¯ã®å¼·ã•ãŒé­…åŠ›ã¨ã—ã¦ä¼ã‚ã‚Šã‚„ã™ã„æ™‚æœŸã€‚ç´ ç›´ãªè¡¨ç¾ã‚’å¿ƒãŒã‘ã¦ã€‚";
      }

      const work = " ã€ä»•äº‹ã€‘" + (["åœŸ", "é‡‘"].includes(hElement)
        ? "å …å®Ÿãªç©ã¿ä¸Šã’ãŒå¤§ããªæˆæœã«ç¹‹ãŒã‚Šã¾ã™ã€‚ç„¦ã‚‰ãšç€å®Ÿãªä¸€æ­©ã‚’ã€‚"
        : "ç›´æ„Ÿã‚„ã‚¢ã‚¤ãƒ‡ã‚¢ãŒå…‰ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚æ–°ã—ã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’è©¦ã—ã¦ã¿ã‚‹ä¾¡å€¤ã‚ã‚Šã€‚");

      const intp = " ã€å¯¾äººã€‘" + (isLpOdd
        ? "æ˜ã‚‹ã„ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå‘¨å›²ã‚’ç‰½å¼•ã—ã¾ã™ã€‚ç©æ¥µçš„ãªå£°ã‹ã‘ãŒå¥½å¾ªç’°ã‚’ç”Ÿã‚€ã§ã—ã‚‡ã†ã€‚"
        : "èãå½¹ã«å¾¹ã™ã‚‹ã“ã¨ã§ã€æ·±ã„ä¿¡é ¼é–¢ä¿‚ã‚’ç¯‰ã‘ã‚‹æ™‚æœŸã€‚ç›¸æ‰‹ã®è¨€è‘‰ã«è€³ã‚’å‚¾ã‘ã¦ã€‚");

      const money = " ã€é‡‘é‹ã€‘" + ([8, 22].includes(lp) || hElement === "é‡‘"
        ? "è±Šã‹ã•ã‚’å¼•ãå¯„ã›ã‚‹åŠ›ãŒå¼·ã„æ™‚ã€‚è‡ªå·±æŠ•è³‡ã‚„é•·æœŸçš„ãªè¨ˆç”»ã«ãŠé‡‘ã‚’ä½¿ã†ã®ãŒãŠã™ã™ã‚ã€‚"
        : "å …å®Ÿãªç®¡ç†ãŒé‡‘é‹å®‰å®šã®éµã€‚æ—¥ã€…ã®å°ã•ãªæ„Ÿè¬ãŒæ›´ãªã‚‹è±Šã‹ã•ã‚’å‘¼ã³è¾¼ã¿ã¾ã™ã€‚");

      return `\n${romance}${work}${intp}${money}`;
    }

    // é€†ä½ç½®ã®æ™‚ã¯é€†ä½ç½®ã ã‘è¡¨ç¤ºï¼ˆæ­£ä½ç½®ã¯è¡¨ç¤ºã—ãªã„ï¼‰
    function renderCard(card, isReversed, positionLabel) {

      // --- ãƒ‡ãƒ¼ã‚¿å–å¾— ---
      const isThree = (positionLabel === "éå»" || positionLabel === "ç¾åœ¨" || positionLabel === "æœªæ¥");
      const kwLimit = isThree ? 6 : 10;
      const kw = splitKeywords(isReversed ? card.keywords_reversed : card.keywords_upright, kwLimit);
      const core = (isReversed ? card.core_reversed : card.core_upright) || "";
      const interpretation = (isReversed ? card.interpretation_reversed : card.interpretation_upright) || "";
      const angel = (isReversed ? card.angel_reversed : card.angel_upright) || "";
      const action = (isReversed ? card.action_reversed : card.action_upright) || "";
      const yn = (isReversed ? card.yes_no_reversed : card.yes_no_upright) || "";
      const meta = metaLine(card);
      const themes = (card.themes ?? "").toString().trim();

      // --- è¡¨ç¤ºãƒ–ãƒ­ãƒƒã‚¯ ---
      const coreBlock = `
    <div class="line">
      <span class="k">è¦ç‚¹ï¼š</span>
     <div class="coreText">${escapeHtml(strengthenCore(core, themes))}</div>
    </div>
  `;

      const interpretationBlock = `
    <div class="line"><span class="k">èª­ã¿è§£ãï¼š</span>${escapeHtml(interpretation)}</div>
  `;

      const angelBlock = `
    <div class="line"><span class="k">å¤©ä½¿ã‹ã‚‰ã®è¨€è‘‰ï¼š</span>${escapeHtml(angel)}</div>
  `;

      const actionBlock = `
    <div class="line"><span class="k">ä»Šæ—¥ã®ä¸€æ­©ï¼š</span>${escapeHtml(action)}</div>
  `;

      // --- ä½ç½®åˆ¥å‡ºã—åˆ†ã‘ ---
      let mainMessageHTML = "";

      if (positionLabel === "éå»") {
        mainMessageHTML = coreBlock;
      } else if (positionLabel === "ç¾åœ¨") {
        mainMessageHTML = coreBlock + interpretationBlock;
      } else if (positionLabel === "æœªæ¥") {
        mainMessageHTML = coreBlock + angelBlock + actionBlock;
      } else {
        // 1æšå¼•ã
        mainMessageHTML = coreBlock + interpretationBlock + angelBlock + actionBlock;
      }

      // --- HTMLè¿”å´ ---
      return `
    <div class="tcard">
      <div class="tcardHeader">
        <div class="tcardTitle">
          <div class="pos">${escapeHtml(positionLabel)}</div>
          <div class="name">${escapeHtml(card.name_ja)} <span class="sub">(${escapeHtml(card.name_en)})</span></div>
          <div class="sub">${escapeHtml(meta)}</div>
          ${themes ? `<div class="sub">ãƒ†ãƒ¼ãƒï¼š${escapeHtml(themes)}</div>` : ``}
        </div>
        <div class="badge ${isReversed ? "rev" : "up"}">${isReversed ? "é€†ä½ç½®" : "æ­£ä½ç½®"}</div>
      </div>

      <div class="tcardVisual">
        <img class="cardImg ${isReversed ? "reversed" : ""}"
          src="${cardImageUrl(card.image)}"
          alt="${escapeHtml(card.name_ja)}"
          onerror="handleCardImgError(this)"
        />
      </div>

      ${yn ? `
        <div class="ynRow">
          <div class="yn ${isReversed ? "rev" : "up"}">YES / NOï¼š${escapeHtml(yn)}</div>
        </div>` : ``}

      <div class="tcardBody">
        <div class="line">
          <span class="k">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆ${isReversed ? "é€†" : "æ­£"}ï¼‰ï¼š</span>
         <div class="kwWrap">
  ${kw.length
          ? kw.map(w => `<span class="kw ${isReversed ? "rev" : "up"}">${escapeHtml(w)}</span>`).join("")
          : `<span class="small">ï¼ˆãªã—ï¼‰</span>`
        }
</div>

        </div>
        ${mainMessageHTML}
      </div>
    </div>
  `;
    }

    function cardImageUrl(image) {
      let raw = (image ?? "").toString().trim();
      if (!raw) return "public/cards/back.png";

      raw = raw
        .replace(/^\uFEFF/, "")
        .replace(/^"+|"+$/g, "")
        .replace(/^'+|'+$/g, "")
        .replace(/^\/+/, "")
        .replace(/\\/g, "/");

      // æ‹¡å¼µå­ãŒç„¡ã„ãªã‚‰ png ã‚’ä»˜ã‘ã‚‹ï¼ˆwebp ç­‰ã¯ onerror å´ã§å·®ã—æ›¿ãˆï¼‰
      if (!/\.(png|jpg|jpeg|webp)$/i.test(raw)) {
        raw += ".png";
      }

      // ã™ã§ã«çµ¶å¯¾URLãªã‚‰ãã®ã¾ã¾
      if (/^https?:\/\//i.test(raw)) return raw;

      // raw ãŒ "wands/xxx.png" ã¿ãŸã„ã«æ¥ã‚‹å‰æï¼šå¿…ãš public/cards/ ã‚’ä»˜ã‘ã‚‹
      return encodeURI("public/cards/" + raw);
    }



    function handleCardImgError(img) {
      const tried = parseInt(img.dataset.tried || "0", 10);

      // ã¾ãšã€å…ƒã® src ã‹ã‚‰ã€Œæ‹¡å¼µå­ã ã‘ã€å·®ã—æ›¿ãˆã¦è©¦ã™
      const src = img.getAttribute("src") || "";
      const base = src.replace(/\.(webp|png|jpg|jpeg)(\?.*)?$/i, ""); // æœ«å°¾æ‹¡å¼µå­ã‚’é™¤å»
      const query = (src.match(/(\?.*)$/) || [""])[0];

      const exts = ["webp", "png", "jpg", "jpeg"];

      // ã™ã§ã« back.png ãªã‚‰çµ‚äº†ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
      if (src.includes("back.png")) return;

      if (tried < exts.length) {
        img.dataset.tried = String(tried + 1);
        img.src = `${base}.${exts[tried]}${query}`;
        return;
      }
      console.warn("[MISSING IMAGE]", {
        alt: img.alt,
        lastTried: src,
        base
      });

      // æœ€å¾Œã®ç ¦ï¼šè£é¢
      img.src = "public/cards/back.png";
    }


    // ---- HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ----
    function escapeHtml(str) {
      return (str ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    /* =========================================
       âœ¨ Share & Copy Logic
       ========================================= */
    function getResultPlainText() {
      // ç”»é¢ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€æ‹¬å–å¾—ã—ã¦æ•´å½¢
      const res = document.getElementById("result");
      if (!res || !res.innerText) return "";

      let text = res.innerText;
      // ä¸è¦ãªãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é™¤å»
      text = text.replace(/Share This Reading\nShare\nCopy\nShare Image\nã‚‚ã†ä¸€åº¦ã²ã\næ•°å­—ã®æ„å‘³ã‚’è©³ã—ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã“ã¡ã‚‰/g, "");
      return text.trim() + "\n\n#AngeliqueTarot\nhttps://angeliquetarot.github.io/";
    }

    function copyResultText() {
      const text = getResultPlainText();
      if (!text) return;

      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }).catch(err => {
          console.error("Copy failed", err);
          fallbackCopyText(text);
        });
      } else {
        fallbackCopyText(text);
      }
    }

    function fallbackCopyText(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      // è¡¨ç¤ºé ˜åŸŸå¤–ã«
      textArea.style.position = "fixed";
      textArea.style.top = "-999999px";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        const successful = document.execCommand('copy');
        if (successful) showToast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        else showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
      } catch (err) {
        console.error('Fallback copy fail', err);
        showToast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      document.body.removeChild(textArea);
    }

    function shareResultText() {
      const text = getResultPlainText();
      if (!text) return;

      if (navigator.share) {
        navigator.share({
          title: 'Angelique Tarot Reading',
          text: text
        }).then(() => {
          console.log('Thanks for sharing!');
        }).catch(console.error);
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚³ãƒ”ãƒ¼
        copyResultText();
        showToast("ã‚·ã‚§ã‚¢æ©Ÿèƒ½ãŒéå¯¾å¿œã®ãŸã‚ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      }
    }

    // --- Share Image (Canvas) ---
    async function shareResultImage() {
      const canvas = document.getElementById("shareCanvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");

      showToast("ç”»åƒã‚’ç”Ÿæˆä¸­...", 2000);

      // 1. èƒŒæ™¯æç”» (æš—ã„ãƒˆãƒ¼ãƒ³)
      ctx.fillStyle = "#11111d";
      ctx.fillRect(0, 0, 1080, 1080);

      // ä¸Šéƒ¨ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      let grad = ctx.createLinearGradient(0, 0, 0, 400);
      grad.addColorStop(0, "rgba(245, 230, 179, 0.15)");
      grad.addColorStop(1, "rgba(17, 17, 29, 0)");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, 1080, 1080);

      // 2. é‡‘è‰²ã®æ ç·š
      ctx.strokeStyle = "rgba(214, 178, 94, 0.4)";
      ctx.lineWidth = 4;
      ctx.strokeRect(40, 40, 1000, 1000);
      ctx.strokeStyle = "rgba(214, 178, 94, 0.15)";
      ctx.lineWidth = 1;
      ctx.strokeRect(50, 50, 980, 980);

      // 3. ã‚¿ã‚¤ãƒˆãƒ«
      ctx.fillStyle = "#f5e6b3"; // pale gold
      ctx.font = "40px 'Cinzel', serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText("Angelique Tarot", 540, 80);

      const today = new Date();
      const dateStr = `${today.getFullYear()}.${String(today.getMonth() + 1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')}`;
      ctx.font = "24px 'Cinzel', serif";
      ctx.fillStyle = "rgba(255,255,255,0.7)";
      ctx.fillText(dateStr, 540, 130);

      // 4. ç”»åƒã®æç”» (ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’é›†ã‚ã‚‹)
      const imgs = document.querySelectorAll("#result .cardImg");
      if (imgs.length === 0) {
        showToast("ã‚«ãƒ¼ãƒ‰ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      const drawMode = document.querySelector('input[name="drawMode"]:checked')?.value || "1";
      const count = (String(drawMode) === "3") ? 3 : 1;

      // ä½•æšå¼•ãã‹ã§ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´
      // ã‚«ãƒ¼ãƒ‰æ¯”ç‡ ç´„ 1 : 1.6
      const cardW = count === 1 ? 300 : 240;
      const cardH = count === 1 ? 480 : 384;
      const startY = 220;

      // ç”»åƒã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦æç”»ã™ã‚‹Promiseã‚’ä½œæˆ
      const loadImg = (src, isReversed) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.crossOrigin = "Anonymous"; // é‡è¦: CORSå›é¿
          img.onload = () => resolve({ img, isReversed, ok: true });
          img.onerror = () => resolve({ img: null, isReversed, ok: false });
          img.src = src;
        });
      };

      const promises = [];
      // DOMå´ã®ã‚«ãƒ¼ãƒ‰çŠ¶æ…‹ã‚’å–å¾— (æ­£é€†å«ã‚€)
      const cardElements = document.querySelectorAll("#result .tcard");
      cardElements.forEach(cel => {
        const imgEl = cel.querySelector("img");
        // tcardVisual > img
        if (imgEl) {
          const isReversed = cel.querySelector(".badge")?.classList.contains("rev") || imgEl.classList.contains("reversed");
          promises.push(loadImg(imgEl.src, isReversed));
        } else {
          // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ä¿é™º
          const reversedFallback = cel.querySelector("img.reversed");
          if (reversedFallback) promises.push(loadImg(reversedFallback.src, true));
        }
      });

      const loadedImgs = await Promise.all(promises);
      const validImgs = loadedImgs.filter(item => item.ok);

      if (validImgs.length === 1) {
        // 1æšå¼•ã
        drawCardOnCanvas(ctx, validImgs[0], 540 - cardW / 2, startY, cardW, cardH);
      } else if (validImgs.length === 3) {
        // 3æšå¼•ã
        const gap = 40;
        const totalW = cardW * 3 + gap * 2; // 720 + 80 = 800
        const startX = 540 - totalW / 2;
        drawCardOnCanvas(ctx, validImgs[0], startX, startY, cardW, cardH);
        drawCardOnCanvas(ctx, validImgs[1], startX + cardW + gap, startY, cardW, cardH);
        drawCardOnCanvas(ctx, validImgs[2], startX + (cardW + gap) * 2, startY, cardW, cardH);
      }

      // 5. çµè«–ãƒ†ã‚­ã‚¹ãƒˆ
      // .summaryTitle ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
      const summaryTitleEl = document.querySelector("#result .summaryTitle");
      if (summaryTitleEl) {
        ctx.font = "bold 28px 'Noto Serif JP', serif";
        ctx.fillStyle = "rgba(255,255,255,0.95)";
        ctx.fillText(summaryTitleEl.innerText.replace("ã€çµè«–ã€‘", ""), 540, startY + cardH + 60);
      }

      // Footer text
      ctx.font = "20px 'Noto Serif JP', serif";
      ctx.fillStyle = "rgba(255,255,255,0.5)";
      ctx.fillText("Search 'Angelique Tarot' to pull your own cards.", 540, 980);

      // 6. å‡ºåŠ›
      canvas.toBlob((blob) => {
        if (!blob) {
          showToast("ç”»åƒã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
          return;
        }

        const file = new File([blob], "reading.png", { type: "image/png" });

        // Share API å¯¾å¿œãƒã‚§ãƒƒã‚¯
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            files: [file],
            title: 'Angelique Tarot Reading',
            text: 'ç§ã®ã‚¿ãƒ­ãƒƒãƒˆãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœã§ã™ #AngeliqueTarot'
          }).then(() => {
            console.log('Image shared successfully');
          }).catch((err) => {
            console.error("Share failed:", err);
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆãªã©ã‚‚ã“ã“ã«æ¥ã‚‹ã®ã§ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¯æ§ãˆã‚ã«
          });
        } else {
          // éå¯¾å¿œãªã‚‰æ–°è¦ã‚¿ãƒ–ã§ç”»åƒè¡¨ç¤º
          showToast("è¡¨ç¤ºã•ã‚ŒãŸç”»åƒã‚’é•·æŠ¼ã—ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ï¼‰ã§ä¿å­˜ã—ã¦ãã ã•ã„", 4000);
          const dataUrl = canvas.toDataURL("image/png");
          const newWin = window.open();
          if (newWin) {
            newWin.document.write(`<img src="${dataUrl}" style="max-width:100%;height:auto;display:block;margin:0 auto;box-shadow:0 10px 30px rgba(0,0,0,0.5);">`);
          } else {
            fallbackCopyText(getResultPlainText());
            showToast("ç”»åƒã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚");
          }
        }
      }, "image/png");
    }

    function drawCardOnCanvas(ctx, item, x, y, w, h) {
      if (!item || !item.img) return;
      ctx.save();

      // å½±
      ctx.shadowColor = "rgba(0,0,0,0.8)";
      ctx.shadowBlur = 20;
      ctx.shadowOffsetY = 10;

      if (item.isReversed) {
        // é€†ä½ç½®ãªã‚‰å›è»¢
        ctx.translate(x + w / 2, y + h / 2);
        ctx.rotate(Math.PI);
        ctx.drawImage(item.img, -w / 2, -h / 2, w, h);
      } else {
        ctx.drawImage(item.img, x, y, w, h);
      }
      ctx.restore();
    }

  </script>
  <!-- <script src="numerology_logic_pure.js"></script> -->
  <script src="assets/js/energy/energy_logic_clean.js"></script>
</body>


</html>